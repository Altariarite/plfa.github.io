\hypertarget{Soundness}{%
\chapter{Soundness: Soundness of reduction with respect to denotational
semantics}\label{Soundness}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{plfa.part3.Soundness}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
\end{fence}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

In this chapter we prove that the reduction semantics is sound with
respect to the denotational semantics, i.e., for any term L

\begin{myDisplay}
L —↠ ƛ N  implies  ℰ L ≃ ℰ (ƛ N)
\end{myDisplay}

The proof is by induction on the reduction sequence, so the main lemma
concerns a single reduction step. We prove that if any term \texttt{M}
steps to a term \texttt{N}, then \texttt{M} and \texttt{N} are
denotationally equal. We shall prove each direction of this
if-and-only-if separately. One direction will look just like a type
preservation proof. The other direction is like proving type
preservation for reduction going in reverse. Recall that type
preservation is sometimes called subject reduction. Preservation in
reverse is a well-known property and is called \emph{subject expansion}.
It is also well-known that subject expansion is false for most typed
lambda calculi!

\hypertarget{imports}{%
\section{Imports}\label{imports}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}≡\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}≢\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{cong₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{cong-app}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}×\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaRecord{Σ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Σ-syntax}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{∃}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{∃-syntax}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₂}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨\AgdaUnderscore{},\AgdaUnderscore{}⟩}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Agda.Primitive}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaPrimitive{lzero}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{¬\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary.Negation}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{contradiction}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊥-elim}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaRecord{Dec}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}∘\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}%
\>[50I]\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{plfa.part2.Untyped}\<%
\\
\>[.][@{}l@{}]\<[50I]%
\>[5]\AgdaKeyword{using}%
\>[52I]\AgdaSymbol{(}\AgdaDatatype{Context}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}∋\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{S\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}·\AgdaUnderscore{}}}\AgdaSymbol{;}\<%
\\
\>[52I][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaFunction{subst}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}[\AgdaUnderscore{}]}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{subst-zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{ext}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSymbol{;}\<%
\\
%
\>[12]\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}—→\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{ξ₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{ξ₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{β}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{ζ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}—↠\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}—→⟨\AgdaUnderscore{}⟩\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∎}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{plfa.part2.Substitution}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Rename}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{ids}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}%
\>[80I]\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{plfa.part3.Denotational}\<%
\\
\>[.][@{}l@{}]\<[80I]%
\>[5]\AgdaKeyword{using}%
\>[82I]\AgdaSymbol{(}\AgdaDatatype{Value}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢\AgdaUnderscore{}↓\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`,\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`⊑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{`⊥}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`⊔\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{init}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{last}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{init-last}\AgdaSymbol{;}\<%
\\
\>[82I][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaFunction{⊑-refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-trans}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{`⊑-refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{⊑-env}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{⊑-env-conj-R1}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{⊑-env-conj-R2}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{up-env}\AgdaSymbol{;}\<%
\\
%
\>[12]\AgdaInductiveConstructor{var}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-intro}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSymbol{;}\<%
\\
%
\>[12]\AgdaFunction{rename-pres}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}≃\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{≃-trans}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{plfa.part3.Compositional}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lambda-inversion}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{var-inv}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

\hypertarget{forward-reduction-preserves-denotations}{%
\section{Forward reduction preserves
denotations}\label{forward-reduction-preserves-denotations}}

The proof of preservation in this section mixes techniques from previous
chapters. Like the proof of preservation for the STLC, we are preserving
a relation defined separately from the syntax, in contrast to the
intrinsically-typed terms. On the other hand, we are using de Bruijn
indices for variables.

The outline of the proof remains the same in that we must prove lemmas
concerning all of the auxiliary functions used in the reduction
relation: substitution, renaming, and extension.

\hypertarget{simultaneous-substitution-preserves-denotations}{%
\subsection{Simultaneous substitution preserves
denotations}\label{simultaneous-substitution-preserves-denotations}}

Our next goal is to prove that simultaneous substitution preserves
meaning. That is, if \texttt{M} results in \texttt{v} in environment
\texttt{γ}, then applying a substitution \texttt{σ} to \texttt{M} gives
us a program that also results in \texttt{v}, but in an environment
\texttt{δ} in which, for every variable \texttt{x}, \texttt{σ\ x}
results in the same value as the one for \texttt{x} in the original
environment \texttt{γ}. We write \texttt{δ\ ⊢\ σ\ ↓\ γ} for this
condition.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`⊢\AgdaUnderscore{}↓\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`⊢\AgdaUnderscore{}↓\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`⊢\AgdaUnderscore{}↓\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(∀}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

As usual, to prepare for lambda abstraction, we prove an extension
lemma. It says that applying the \texttt{exts} function to a
substitution produces a new substitution that maps variables to terms
that when evaluated in \texttt{δ\ ,\ v} produce the values in
\texttt{γ\ ,\ v}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-ext}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaComment{--------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{subst-ext}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\<%
\\
\>[0]\AgdaFunction{subst-ext}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{S\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{x′}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

The proof is by cases on the de Bruijn index \texttt{x}.

\begin{itemize}
\item
  If it is \texttt{Z}, then we need to show that
  \texttt{δ\ ,\ v\ ⊢\ \#\ 0\ ↓\ v}, which we have by rule \texttt{var}.
\item
  If it is \texttt{S\ x′},then we need to show that
  \texttt{δ\ ,\ v\ ⊢\ rename\ S\_\ (σ\ x′)\ ↓\ γ\ x′}, which we obtain
  by the \texttt{rename-pres} lemma.
\end{itemize}

With the extension lemma in hand, the proof that simultaneous
substitution preserves meaning is straightforward. Let's dive in!

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[228I]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[228I]%
\>[4]\AgdaComment{------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-ext}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\end{code}
\end{fence}

The proof is by induction on the semantics of \texttt{M}. The two
interesting cases are for variables and lambda abstractions.

\begin{itemize}
\item
  For a variable \texttt{x}, we have that \texttt{v\ ⊑\ γ\ x} and we
  need to show that \texttt{δ\ ⊢\ σ\ x\ ↓\ v}. From the premise applied
  to \texttt{x}, we have that \texttt{δ\ ⊢\ σ\ x\ ↓\ γ\ x}, so we
  conclude by the \texttt{sub} rule.
\item
  For a lambda abstraction, we must extend the substitution for the
  induction hypothesis. We apply the \texttt{subst-ext} lemma to show
  that the extended substitution maps variables to terms that result in
  the appropriate values.
\end{itemize}

\hypertarget{single-substitution-preserves-denotations}{%
\subsection{Single substitution preserves
denotations}\label{single-substitution-preserves-denotations}}

For β reduction, \texttt{(ƛ\ N)\ ·\ M\ —→\ N\ {[}\ M\ {]}}, we need to
show that the semantics is preserved when substituting \texttt{M} for de
Bruijn index 0 in term \texttt{N}. By inversion on the rules
\texttt{↦-elim} and \texttt{↦-intro}, we have that
\texttt{γ\ ,\ v\ ⊢\ M\ ↓\ w} and \texttt{γ\ ⊢\ N\ ↓\ v}. So we need to
show that \texttt{γ\ ⊢\ M\ {[}\ N\ {]}\ ↓\ w}, or equivalently, that
\texttt{γ\ ⊢\ subst\ (subst-zero\ N)\ M\ ↓\ w}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
%
\>[3]\AgdaSymbol{→}%
\>[327I]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[327I]%
\>[5]\AgdaComment{---------------}\<%
\\
%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{substitution}\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}\{}\AgdaBound{w}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{dn}\AgdaSpace{}%
\AgdaBound{dm}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaFunction{sub-z-ok}\AgdaSpace{}%
\AgdaBound{dn}\<%
\\
%
\>[2]\AgdaKeyword{where}\<%
\\
%
\>[2]\AgdaFunction{sub-z-ok}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub-z-ok}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{dm}\<%
\\
%
\>[2]\AgdaFunction{sub-z-ok}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\<%
\end{code}
\end{fence}

This result is a corollary of the lemma for simultaneous substitution.
To use the lemma, we just need to show that \texttt{subst-zero\ M} maps
variables to terms that produces the same values as those in
\texttt{γ\ ,\ v}. Let \texttt{y} be an arbitrary variable (de Bruijn
index).

\begin{itemize}
\item
  If it is \texttt{Z}, then \texttt{(subst-zero\ M)\ y\ =\ M} and
  \texttt{(γ\ ,\ v)\ y\ =\ v}. By the premise we conclude that
  \texttt{γ\ ⊢\ M\ ↓\ v}.
\item
  If it is \texttt{S\ x}, then \texttt{(subst-zero\ M)\ (S\ x)\ =\ x}
  and \texttt{(γ\ ,\ v)\ (S\ x)\ =\ γ\ x}. So we conclude that
  \texttt{γ\ ⊢\ x\ ↓\ γ\ x} by rule \texttt{var}.
\end{itemize}

\hypertarget{reduction-preserves-denotations}{%
\subsection{Reduction preserves
denotations}\label{reduction-preserves-denotations}}

With the substitution lemma in hand, it is straightforward to prove that
reduction preserves denotations.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[378I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[378I]%
\>[4]\AgdaComment{----------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{d₂}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{β}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lambda-inversion}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{d₂}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ζ}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\end{code}
\end{fence}

We proceed by induction on the semantics of \texttt{M} with case
analysis on the reduction.

\begin{itemize}
\item
  If \texttt{M} is a variable, then there is no such reduction.
\item
  If \texttt{M} is an application, then the reduction is either a
  congruence (ξ₁ or ξ₂) or β. For each congruence, we use the induction
  hypothesis. For β reduction we use the substitution lemma and the
  \texttt{sub} rule.
\item
  The rest of the cases are straightforward.
\end{itemize}

\hypertarget{reduction-reflects-denotations}{%
\section{Reduction reflects
denotations}\label{reduction-reflects-denotations}}

This section proves that reduction reflects the denotation of a term.
That is, if \texttt{N} results in \texttt{v}, and if \texttt{M} reduces
to \texttt{N}, then \texttt{M} also results in \texttt{v}. While there
are some broad similarities between this proof and the above proof of
semantic preservation, we shall require a few more technical lemmas to
obtain this result.

The main challenge is dealing with the substitution in β reduction:

\begin{myDisplay}
(ƛ N) · M —→ N [ M ]
\end{myDisplay}

We have that \texttt{γ\ ⊢\ N\ {[}\ M\ {]}\ ↓\ v} and need to show that
\texttt{γ\ ⊢\ (ƛ\ N)\ ·\ M\ ↓\ v}. Now consider the derivation of
\texttt{γ\ ⊢\ N\ {[}\ M\ {]}\ ↓\ v}. The term \texttt{M} may occur 0, 1,
or many times inside \texttt{N\ {[}\ M\ {]}}. At each of those
occurrences, \texttt{M} may result in a different value. But to build a
derivation for \texttt{(ƛ\ N)\ ·\ M}, we need a single value for
\texttt{M}. If \texttt{M} occurred more than 1 time, then we can join
all of the different values using \texttt{⊔}. If \texttt{M} occurred 0
times, then we do not need any information about \texttt{M} and can
therefore use \texttt{⊥} for the value of \texttt{M}.

\hypertarget{renaming-reflects-meaning}{%
\subsection{Renaming reflects meaning}\label{renaming-reflects-meaning}}

Previously we showed that renaming variables preserves meaning. Now we
prove the opposite, that it reflects meaning. That is, if
\texttt{δ\ ⊢\ rename\ ρ\ M\ ↓\ v}, then \texttt{γ\ ⊢\ M\ ↓\ v}, where
\texttt{(δ\ ∘\ ρ)}⊑ γ`.

First, we need a variant of a lemma given earlier.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ext-⊑′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Rename}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[472I]\AgdaSymbol{(}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊑}}\AgdaSpace{}%
\AgdaBound{γ}\<%
\\
\>[.][@{}l@{}]\<[472I]%
\>[4]\AgdaComment{------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊑}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{ext-⊑′}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\<%
\\
\>[0]\AgdaFunction{ext-⊑′}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaBound{x}\<%
\end{code}
\end{fence}

The proof is then as follows.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Rename}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊑}}\AgdaSpace{}%
\AgdaBound{γ}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[528I]\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[528I]%
\>[4]\AgdaComment{------------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[12]\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-trans}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext-⊑′}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaBound{all-n}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\end{code}
\end{fence}

We cannot prove this lemma by induction on the derivation of
\texttt{δ\ ⊢\ rename\ ρ\ M\ ↓\ v}, so instead we proceed by induction on
\texttt{M}.

\begin{itemize}
\item
  If it is a variable, we apply the inversion lemma to obtain that
  \texttt{v\ ⊑\ δ\ (ρ\ x)}. Instantiating the premise to \texttt{x} we
  have \texttt{δ\ (ρ\ x)\ =\ γ\ x}, so we conclude by the \texttt{var}
  rule.
\item
  If it is a lambda abstraction \texttt{ƛ\ N}, we have rename
  \texttt{ρ\ (ƛ\ N)\ =\ ƛ\ (rename\ (ext\ ρ)\ N)}. We proceed by cases
  on \texttt{δ\ ⊢\ ƛ\ (rename\ (ext\ ρ)\ N)\ ↓\ v}.

  \begin{itemize}
  \item
    Rule \texttt{↦-intro}: To satisfy the premise of the induction
    hypothesis, we prove that the renaming can be extended to be a
    mapping from \texttt{γ\ ,\ v₁\ to\ δ\ ,\ v₁}.
  \item
    Rule \texttt{⊥-intro}: We simply apply \texttt{⊥-intro}.
  \item
    Rule \texttt{⊔-intro}: We apply the induction hypotheses and
    \texttt{⊔-intro}.
  \item
    Rule \texttt{sub}: We apply the induction hypothesis and
    \texttt{sub}.
  \end{itemize}
\item
  If it is an application \texttt{L\ ·\ M}, we have
  \texttt{rename\ ρ\ (L\ ·\ M)\ =\ (rename\ ρ\ L)\ ·\ (rename\ ρ\ M)}.
  We proceed by cases on
  \texttt{δ\ ⊢\ (rename\ ρ\ L)\ ·\ (rename\ ρ\ M)\ ↓\ v} and all the
  cases are straightforward.
\end{itemize}

In the upcoming uses of \texttt{rename-reflect}, the renaming will
always be the increment function. So we prove a corollary for that
special case.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{rename-inc-reflect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{v′}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[678I]\AgdaSymbol{(}\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{S\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[678I]%
\>[4]\AgdaComment{----------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{rename-inc-reflect}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename-reflect}\AgdaSpace{}%
\AgdaFunction{`⊑-refl}\AgdaSpace{}%
\AgdaBound{d}\<%
\end{code}
\end{fence}

\hypertarget{substitution-reflects-denotations-the-variable-case}{%
\subsection{Substitution reflects denotations, the variable
case}\label{substitution-reflects-denotations-the-variable-case}}

We are almost ready to begin proving that simultaneous substitution
reflects denotations. That is, if \texttt{γ\ ⊢\ (subst\ σ\ M)\ ↓\ v},
then \texttt{γ\ ⊢\ σ\ k\ ↓\ δ\ k} and \texttt{δ\ ⊢\ M\ ↓\ v} for any
\texttt{k} and some \texttt{δ}. We shall start with the case in which
\texttt{M} is a variable \texttt{x}. So instead the premise is
\texttt{γ\ ⊢\ σ\ x\ ↓\ v} and we need to show that
\texttt{δ\ ⊢\ x\ ↓\ v} for some \texttt{δ}. The \texttt{δ} that we
choose shall be the environment that maps \texttt{x} to \texttt{v} and
every other variable to \texttt{⊥}.

Next we define the environment that maps \texttt{x} to \texttt{v} and
every other variable to \texttt{⊥}, that is \texttt{const-env\ x\ v}. To
tell variables apart, we define the following function for deciding
equality of variables.

\begin{fence}
\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}var≟\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaRecord{Dec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}%
\>[10]\AgdaSymbol{=}%
\>[13]\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[14]\AgdaSymbol{=}%
\>[17]\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{λ()}\<%
\\
\>[0]\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}%
\>[14]\AgdaSymbol{=}%
\>[17]\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{λ()}\<%
\\
\>[0]\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}%
\>[23]\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaBound{y}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[20]\AgdaSymbol{|}%
\>[23]\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[35]\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[20]\AgdaSymbol{|}%
\>[23]\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaBound{neq}%
\>[32]\AgdaSymbol{=}%
\>[35]\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{λ\{}\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{neq}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{\}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{var≟-refl}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{var≟-refl}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{var≟-refl}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{var≟-refl}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}
\end{fence}

Now we use \texttt{var≟} to define \texttt{const-env}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{const-env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
\>[0]\AgdaFunction{const-env}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaBound{y}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[16]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[16]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\<%
\end{code}
\end{fence}

Of course, \texttt{const-env\ x\ v} maps \texttt{x} to value \texttt{v}

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{same-const-env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{const-env}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{same-const-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{var≟-refl}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}
\end{fence}

and \texttt{const-env\ x\ v} maps \texttt{y} to
\texttt{⊥,\ so\ long\ as}x ≢ y`.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{diff-const-env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[821I]\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≢}}\AgdaSpace{}%
\AgdaBound{y}\<%
\\
\>[.][@{}l@{}]\<[821I]%
\>[4]\AgdaComment{-------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{const-env}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\<%
\\
\>[0]\AgdaFunction{diff-const-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{y}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{neq}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaBound{y}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[5]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaBound{eq}%
\>[15]\AgdaSymbol{=}%
\>[18]\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{neq}\AgdaSpace{}%
\AgdaBound{eq}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[5]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[15]\AgdaSymbol{=}%
\>[18]\AgdaInductiveConstructor{refl}\<%
\end{code}
\end{fence}

So we choose \texttt{const-env\ x\ v} for \texttt{δ} and obtain
\texttt{δ\ ⊢\ x\ ↓\ v} with the \texttt{var} rule.

It remains to prove that \texttt{γ\ ⊢\ σ\ ↓\ δ} and
\texttt{δ\ ⊢\ M\ ↓\ v} for any \texttt{k}, given that we have chosen
\texttt{const-env\ x\ v} for \texttt{δ}. We shall have two cases to
consider, \texttt{x\ ≡\ y} or \texttt{x\ ≢\ y}.

Now to finish the two cases of the proof.

\begin{itemize}
\tightlist
\item
  In the case where \texttt{x\ ≡\ y}, we need to show that
  \texttt{γ\ ⊢\ σ\ y\ ↓\ v}, but that's just our premise.
\item
  In the case where \texttt{x\ ≢\ y,} we need to show that
  \texttt{γ\ ⊢\ σ\ y\ ↓\ ⊥}, which we do via rule \texttt{⊥-intro}.
\end{itemize}

Thus, we have completed the variable case of the proof that simultaneous
substitution reflects denotations. Here is the proof again, formally.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-reflect-var}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[863I]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[863I]%
\>[4]\AgdaComment{-----------------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{δ}%
\>[31]\AgdaOperator{\AgdaFunction{×}}%
\>[34]\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{subst-reflect-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{x}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}\{}\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{xv}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{same-const-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{x}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{const-env}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{const-env-ok}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
%
\>[2]\AgdaKeyword{where}\<%
\\
%
\>[2]\AgdaFunction{const-env-ok}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaFunction{const-env}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaFunction{const-env-ok}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{var≟}}\AgdaSpace{}%
\AgdaBound{y}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaBound{x≡y}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{x≡y}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{same-const-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{x}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{xv}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaBound{x≢y}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{diff-const-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{x}\AgdaSymbol{\}\{}\AgdaBound{y}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{x≢y}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\end{code}
\end{fence}

\hypertarget{substitutions-and-environment-construction}{%
\subsection{Substitutions and environment
construction}\label{substitutions-and-environment-construction}}

Every substitution produces terms that can evaluate to \texttt{⊥}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-⊥}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaComment{-----------------}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaFunction{`⊥}\<%
\\
\>[0]\AgdaFunction{subst-⊥}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\end{code}
\end{fence}

If a substitution produces terms that evaluate to the values in both
\texttt{γ₁} and \texttt{γ₂}, then those terms also evaluate to the
values in \texttt{γ₁\ ⊔\ γ₂}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-⊔}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[953I]\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{γ₁}\AgdaSpace{}%
\AgdaBound{γ₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
\>[953I][@{}l@{\AgdaIndent{0}}]%
\>[11]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ₁}\<%
\\
%
\>[11]\AgdaSymbol{→}%
\>[971I]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ₂}\<%
\\
\>[.][@{}l@{}]\<[971I]%
\>[13]\AgdaComment{-------------------------}\<%
\\
%
\>[11]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊔}}\AgdaSpace{}%
\AgdaBound{γ₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-⊔}\AgdaSpace{}%
\AgdaBound{γ₁-ok}\AgdaSpace{}%
\AgdaBound{γ₂-ok}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ₁-ok}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ₂-ok}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

\hypertarget{the-lambda-constructor-is-injective}{%
\subsection{The Lambda constructor is
injective}\label{the-lambda-constructor-is-injective}}

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lambda-inj}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1004I]\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}≡\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{A}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1004I]%
\>[4]\AgdaComment{---------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[0]\AgdaFunction{lambda-inj}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}
\end{fence}

\hypertarget{simultaneous-substitution-reflects-denotations}{%
\subsection{Simultaneous substitution reflects
denotations}\label{simultaneous-substitution-reflects-denotations}}

In this section we prove a central lemma, that substitution reflects
denotations. That is, if \texttt{γ\ ⊢\ subst\ σ\ M\ ↓\ v}, then
\texttt{δ\ ⊢\ M\ ↓\ v} and \texttt{γ\ ⊢\ σ\ ↓\ δ} for some \texttt{δ}.
We shall proceed by induction on the derivation of
\texttt{γ\ ⊢\ subst\ σ\ M\ ↓\ v}. This requires a minor restatement of
the lemma, changing the premise to \texttt{γ\ ⊢\ L\ ↓\ v} and
\texttt{L\ ≡\ subst\ σ\ M}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{split}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1037I]\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[1037I]%
\>[4]\AgdaComment{--------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{init}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaFunction{last}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{split}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{δMv}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{init-last}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δMv}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Subst}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[1089I]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{L}\<%
\\
\>[.][@{}l@{}]\<[1089I]%
\>[4]\AgdaComment{---------------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ}%
\>[31]\AgdaOperator{\AgdaFunction{×}}%
\>[34]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaBound{eqL}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}%
\>[11]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[14]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{yv}%
\>[20]\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{eqL}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst-reflect-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{yv}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{M₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M₂}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eqL}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[9]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[7]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[7]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{d′}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{eqL}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst-reflect-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d′}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{M₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M₂}\<%
\\
\>[3][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M₁}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[8]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{subst-δ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{m1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{subst-δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{m2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊔}}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}%
\>[1240I]\AgdaFunction{subst-⊔}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{γ₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSymbol{\}\{}\AgdaArgument{γ₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSymbol{\}\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{subst-δ₁}\AgdaSpace{}%
\AgdaBound{subst-δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[.][@{}l@{}]\<[1240I]%
\>[20]\AgdaInductiveConstructor{↦-elim}%
\>[1251I]\AgdaSymbol{(}\AgdaFunction{⊑-env}\AgdaSpace{}%
\AgdaBound{m1}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊑-env-conj-R1}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[1251I]%
\>[27]\AgdaSymbol{(}\AgdaFunction{⊑-env}\AgdaSpace{}%
\AgdaBound{m2}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊑-env-conj-R2}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eqL}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[7]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[16]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{d′}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{eqL}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst-reflect-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d′}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eq}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lambda-inj}\AgdaSpace{}%
\AgdaBound{eq}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[1304I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{exts-σ-δ′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{m′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[1304I]%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{init}%
\>[1316I]\AgdaBound{δ′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{((λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{rename-inc-reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{exts-σ-δ′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{))))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[1316I][@{}l@{\AgdaIndent{0}}]%
\>[13]\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{up-env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{split}\AgdaSpace{}%
\AgdaBound{m′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{exts-σ-δ′}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{M₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M₂}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaBound{eq}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{`⊥}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{subst-⊥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eq}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{eq}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaBound{eq}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[1379I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{subst-δ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{m1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{subst-δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{m2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[1379I][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊔}}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}%
\>[1405I]\AgdaFunction{subst-⊔}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{γ₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSymbol{\}\{}\AgdaArgument{γ₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSymbol{\}\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{subst-δ₁}\AgdaSpace{}%
\AgdaBound{subst-δ₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[.][@{}l@{}]\<[1405I]%
\>[20]\AgdaInductiveConstructor{⊔-intro}%
\>[1416I]\AgdaSymbol{(}\AgdaFunction{⊑-env}\AgdaSpace{}%
\AgdaBound{m1}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊑-env-conj-R1}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSymbol{))}\<%
\\
\>[.][@{}l@{}]\<[1416I]%
\>[28]\AgdaSymbol{(}\AgdaFunction{⊑-env}\AgdaSpace{}%
\AgdaBound{m2}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊑-env-conj-R2}\AgdaSpace{}%
\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaBound{δ₂}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eq}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{eq}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{subst-δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{subst-δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

\begin{itemize}
\item
  Case \texttt{var}: We have subst \texttt{σ\ M\ ≡\ y}, so \texttt{M}
  must also be a variable, say \texttt{x}. We apply the lemma
  \texttt{subst-reflect-var} to conclude.
\item
  Case \texttt{↦-elim}: We have \texttt{subst\ σ\ M\ ≡\ L₁\ ·\ L₂}. We
  proceed by cases on \texttt{M}.

  \begin{itemize}
  \item
    Case \texttt{M\ ≡\ x}: We apply the \texttt{subst-reflect-var} lemma
    again to conclude.
  \item
    Case \texttt{M\ ≡\ M₁\ ·\ M₂}: By the induction hypothesis, we have
    some \texttt{δ₁} and \texttt{δ₂} such that
    \texttt{δ₁\ ⊢\ M₁\ ↓\ v₁\ ↦\ v₃} and \texttt{γ\ ⊢\ σ\ ↓\ δ₁}, as
    well as \texttt{δ₂\ ⊢\ M₂\ ↓\ v₁} and \texttt{γ\ ⊢\ σ\ ↓\ δ₂}. By
    \texttt{⊑-env} we have \texttt{δ₁\ ⊔\ δ₂\ ⊢\ M₁\ ↓\ v₁\ ↦\ v₃} and
    \texttt{δ₁\ ⊔\ δ₂\ ⊢\ M₂\ ↓\ v₁} (using \texttt{⊑-env-conj-R1} and
    \texttt{⊑-env-conj-R2}), and therefore
    \texttt{δ₁\ ⊔\ δ₂\ ⊢\ M₁\ ·\ M₂\ ↓\ v₃}. We conclude this case by
    obtaining \texttt{γ\ ⊢\ σ\ ↓\ δ₁\ ⊔\ δ₂} by the \texttt{subst-⊔}
    lemma.
  \end{itemize}
\item
  Case \texttt{↦-intro}: We have \texttt{subst\ σ\ M\ ≡\ ƛ\ L′}. We
  proceed by cases on \texttt{M}.

  \begin{itemize}
  \item
    Case \texttt{M\ ≡\ x}: We apply the \texttt{subst-reflect-var}
    lemma.
  \item
    Case \texttt{M\ ≡\ ƛ\ M′}: By the induction hypothesis, we have
    \texttt{(δ′\ ,\ v′)\ ⊢\ M′\ ↓\ v₂} and
    \texttt{(δ\ ,\ v₁)\ ⊢\ exts\ σ\ ↓\ (δ′\ ,\ v′)}. From the later we
    have \texttt{(δ\ ,\ v₁)\ ⊢\ \#\ 0\ ↓\ v′}. By the lemma
    \texttt{var-inv} we have \texttt{v′\ ⊑\ v₁}, so by the
    \texttt{up-env} lemma we have \texttt{(δ′\ ,\ v₁)\ ⊢\ M′\ ↓\ v₂} and
    therefore \texttt{δ′\ ⊢\ ƛ\ M′\ ↓\ v₁\ →\ v₂}. We also need to show
    that \texttt{δ}⊢ σ ↓ δ′\texttt{.\ \ Fix}k\texttt{.\ We\ have}(δ ,
    v₁) ⊢ rename S\_ σ k ↓ δ
    k′\texttt{.\ \ We\ then\ apply\ the\ lemma}rename-inc-reflect\texttt{to\ obtain}δ
    ⊢ σ k ↓ δ k′`, so this case is complete.
  \end{itemize}
\item
  Case \texttt{⊥-intro}: We choose \texttt{⊥} for \texttt{δ}. We have
  \texttt{⊥\ ⊢\ M\ ↓\ ⊥} by \texttt{⊥-intro}. We have
  \texttt{δ\ ⊢\ σ\ ↓\ ⊥} by the lemma \texttt{subst-empty}.
\item
  Case \texttt{⊔-intro}: By the induction hypothesis we have
  \texttt{δ₁\ ⊢\ M\ ↓\ v₁}, \texttt{δ₂\ ⊢\ M\ ↓\ v₂},
  \texttt{δ\ ⊢\ σ\ ↓\ δ₁}, and \texttt{δ\ ⊢\ σ\ ↓\ δ₂}. We have
  \texttt{δ₁\ ⊔\ δ₂\ ⊢\ M\ ↓\ v₁} and \texttt{δ₁\ ⊔\ δ₂\ ⊢\ M\ ↓\ v₂} by
  \texttt{⊑-env} with \texttt{⊑-env-conj-R1} and \texttt{⊑-env-conj-R2}.
  So by \texttt{⊔-intro} we have \texttt{δ₁\ ⊔\ δ₂\ ⊢\ M\ ↓\ v₁\ ⊔\ v₂}.
  By \texttt{subst-⊔} we conclude that \texttt{δ\ ⊢\ σ\ ↓\ δ₁\ ⊔\ δ₂}.
\end{itemize}

\hypertarget{single-substitution-reflects-denotations}{%
\subsection{Single substitution reflects
denotations}\label{single-substitution-reflects-denotations}}

Most of the work is now behind us. We have proved that simultaneous
substitution reflects denotations. Of course, β reduction uses single
substitution, so we need a corollary that proves that single
substitution reflects denotations. That is, given terms
\texttt{N\ :\ (Γ\ ,\ ★\ ⊢\ ★)} and \texttt{M\ :\ (Γ\ ⊢\ ★)}, if
\texttt{γ\ ⊢\ N\ {[}\ M\ {]}\ ↓\ w}, then \texttt{γ\ ⊢\ M\ ↓\ v} and
\texttt{(γ\ ,\ v)\ ⊢\ N\ ↓\ w} for some value \texttt{v}. We have
\texttt{N\ {[}\ M\ {]}\ =\ subst\ (subst-zero\ M)\ N}.

We first prove a lemma about \texttt{subst-zero}, that if
\texttt{δ\ ⊢\ subst-zero\ M\ ↓\ γ}, then
\texttt{γ\ ⊑\ (δ\ ,\ w)\ ×\ δ\ ⊢\ M\ ↓\ w} for some \texttt{w}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-zero-reflect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1474I]\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊢}}\AgdaSpace{}%
\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↓}}\AgdaSpace{}%
\AgdaBound{γ}\<%
\\
\>[.][@{}l@{}]\<[1474I]%
\>[4]\AgdaComment{----------------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊑}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{subst-zero-reflect}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{δσγ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{last}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{lemma}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{δσγ}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{where}\<%
\\
%
\>[2]\AgdaFunction{lemma}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`⊑}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaFunction{last}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{lemma}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}%
\>[11]\AgdaSymbol{=}%
\>[14]\AgdaFunction{⊑-refl}\<%
\\
%
\>[2]\AgdaFunction{lemma}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{δσγ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{S}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{))}\<%
\end{code}
\end{fence}

We choose \texttt{w} to be the last value in \texttt{γ} and we obtain
\texttt{δ\ ⊢\ M\ ↓\ w} by applying the premise to variable \texttt{Z}.
Finally, to prove \texttt{γ\ ⊑\ (δ\ ,\ w)}, we prove a lemma by
induction in the input variable. The base case is trivial because of our
choice of \texttt{w}. In the induction case, \texttt{S\ x}, the premise
\texttt{δ\ ⊢\ subst-zero\ M\ ↓\ γ} gives us
\texttt{δ\ ⊢\ x\ ↓\ γ\ (S\ x)} and then using \texttt{var-inv} we
conclude that \texttt{γ\ (S\ x)\ ⊑\ (δ}, w) (S x)`.

Now to prove that substitution reflects denotations.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{substitution-reflect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1550I]\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[1550I]%
\>[4]\AgdaComment{------------------------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{w}%
\>[30]\AgdaOperator{\AgdaFunction{×}}%
\>[33]\AgdaSymbol{(}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{substitution-reflect}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{subst-reflect}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[5]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δσγ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{γNv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{subst-zero-reflect}\AgdaSpace{}%
\AgdaBound{δσγ}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[7]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{ineq}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{δMw}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{δMw}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{⊑-env}\AgdaSpace{}%
\AgdaBound{γNv}\AgdaSpace{}%
\AgdaBound{ineq}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

We apply the \texttt{subst-reflect} lemma to obtain
\texttt{δ\ ⊢\ subst-zero\ M\ ↓\ γ} and \texttt{γ\ ⊢\ N\ ↓\ v} for some
\texttt{γ}. Using the former, the \texttt{subst-zero-reflect} lemma
gives us \texttt{γ\ ⊑\ (δ\ ,\ w)} and \texttt{δ\ ⊢\ M\ ↓\ w}. We
conclude that \texttt{δ\ ,\ w\ ⊢\ N\ ↓\ v} by applying the
\texttt{⊑-env} lemma, using \texttt{γ\ ⊢\ N\ ↓\ v} and
\texttt{γ\ ⊑\ (δ\ ,\ w)}.

\hypertarget{reduction-reflects-denotations-1}{%
\subsection{Reduction reflects
denotations}\label{reduction-reflects-denotations-1}}

Now that we have proved that substitution reflects denotations, we can
easily prove that reduction does too.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{reflect-beta}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{reflect-beta}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{substitution-reflect}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₂′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{d₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{d₂′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d₂′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{d₁′}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1663I]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}%
\>[15]\AgdaSymbol{→}%
\>[18]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{M′}%
\>[27]\AgdaSymbol{→}%
\>[31]\AgdaBound{M′}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[1663I]%
\>[4]\AgdaComment{---------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSymbol{\{}\AgdaArgument{γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaInductiveConstructor{β}\AgdaSpace{}%
\AgdaBound{mn}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSymbol{\{}\AgdaArgument{γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{d′}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{reflect-beta}\AgdaSpace{}%
\AgdaBound{d′}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ζ}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{d₂}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{β}\AgdaSpace{}%
\AgdaBound{mn}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{d′}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{reflect-beta}\AgdaSpace{}%
\AgdaBound{d′}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ζ}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{β}\AgdaSpace{}%
\AgdaBound{mn}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{d′}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{reflect-beta}\AgdaSpace{}%
\AgdaBound{d′}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ζ}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{mn}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\end{code}
\end{fence}

\hypertarget{reduction-implies-denotational-equality}{%
\section{Reduction implies denotational
equality}\label{reduction-implies-denotational-equality}}

We have proved that reduction both preserves and reflects denotations.
Thus, reduction implies denotational equality.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{reduce-equal}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1839I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[1839I]%
\>[4]\AgdaComment{---------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[0]\AgdaFunction{reduce-equal}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{reflect}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

We conclude with the \emph{soundness property}, that multi-step
reduction to a lambda abstraction implies denotational equivalence with
a lambda abstraction.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{soundness}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1881I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—↠}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[1881I]%
\>[4]\AgdaComment{-----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{soundness}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDottedPattern{\AgdaSymbol{.(}}\AgdaDottedPattern{\AgdaOperator{\AgdaInductiveConstructor{ƛ}}}\AgdaSpace{}%
\AgdaDottedPattern{\AgdaSymbol{\AgdaUnderscore{})}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∎}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{soundness}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{—→⟨}}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaBound{M—↠N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{ih}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{soundness}\AgdaSpace{}%
\AgdaBound{M—↠N}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[3]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{reduce-equal}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[3]\AgdaFunction{≃-trans}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ih}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\end{code}
\end{fence}

\hypertarget{unicode}{%
\section{Unicode}\label{unicode}}

This chapter uses the following unicode:

\begin{myDisplay}
≟  U+225F  QUESTIONED EQUAL TO (\?=)
\end{myDisplay}


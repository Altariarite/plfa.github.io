\hypertarget{Compositional}{%
\chapter{Compositional: The denotational semantics is
compositional}\label{Compositional}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{plfa.part3.Compositional}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
\end{fence}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

In this chapter we prove that the denotational semantics is
compositional, which means we fill in the ellipses in the following
equations.

\begin{myDisplay}
ℰ (` x) ≃ ...
ℰ (ƛ M) ≃ ... ℰ M ...
ℰ (M · N) ≃ ... ℰ M ... ℰ N ...
\end{myDisplay}

Such equations would imply that the denotational semantics could be
instead defined as a recursive function. Indeed, we end this chapter
with such a definition and prove that it is equivalent to ℰ.

\hypertarget{imports}{%
\section{Imports}\label{imports}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}×\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaRecord{Σ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Σ-syntax}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{∃}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{∃-syntax}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₂}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨\AgdaUnderscore{},\AgdaUnderscore{}⟩}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Sum}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊎\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaRecord{⊤}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{plfa.part2.Untyped}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Context}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}∋\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}·\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{plfa.part3.Denotational}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{using}%
\>[38I]\AgdaSymbol{(}\AgdaDatatype{Value}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}↦\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}`,\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊔\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢\AgdaUnderscore{}↓\AgdaUnderscore{}}}\AgdaSymbol{;}\<%
\\
\>[38I][@{}l@{\AgdaIndent{0}}]%
\>[9]\AgdaInductiveConstructor{⊑-bot}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-fun}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-conj-L}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-conj-R1}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-conj-R2}\AgdaSymbol{;}\<%
\\
%
\>[9]\AgdaInductiveConstructor{⊑-dist}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-trans}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{⊔↦⊔-dist}\AgdaSymbol{;}\<%
\\
%
\>[9]\AgdaInductiveConstructor{var}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-intro}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSymbol{;}\<%
\\
%
\>[9]\AgdaFunction{up-env}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}≃\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{≃-sym}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{plfa.part3.Denotational.≃-Reasoning}\<%
\end{code}
\end{fence}

\hypertarget{equation-for-lambda-abstraction}{%
\section{Equation for lambda
abstraction}\label{equation-for-lambda-abstraction}}

Regarding the first equation

\begin{myDisplay}
ℰ (ƛ M) ≃ ... ℰ M ...
\end{myDisplay}

we need to define a function that maps a \texttt{Denotation\ (Γ\ ,\ ★)}
to a \texttt{Denotation\ Γ}. This function, let us name it \texttt{ℱ},
should mimic the non-recursive part of the semantics when applied to a
lambda term. In particular, we need to consider the rules
\texttt{↦-intro}, \texttt{⊥-intro}, and \texttt{⊔-intro}. So \texttt{ℱ}
has three parameters, the denotation \texttt{D} of the subterm
\texttt{M}, an environment \texttt{γ}, and a value \texttt{v}. If we
define \texttt{ℱ} by recursion on the value \texttt{v}, then it matches
up nicely with the three rules \texttt{↦-intro}, \texttt{⊥-intro}, and
\texttt{⊔-intro}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
\>[0]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{w}\<%
\\
\>[0]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
\>[0]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{u}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{u}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

If one squints hard enough, the \texttt{ℱ} function starts to look like
the \texttt{curry} operation familiar to functional programmers. It
turns a function that expects a tuple of length \texttt{n\ +\ 1} (the
environment \texttt{Γ\ ,\ ★}) into a function that expects a tuple of
length \texttt{n} and returns a function of one parameter.

Using this \texttt{ℱ}, we hope to prove that

\begin{myDisplay}
ℰ (ƛ N) ≃ ℱ (ℰ N)
\end{myDisplay}

The function \texttt{ℱ} is preserved when going from a larger value
\texttt{v} to a smaller value \texttt{u}. The proof is a straightforward
induction on the derivation of \texttt{u\ ⊑\ v}, using the
\texttt{up-env} lemma in the case for the \texttt{⊑-fun} rule.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{u}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[119I]\AgdaBound{u}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[119I]%
\>[4]\AgdaComment{------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{u}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-bot}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-fun}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaBound{lt′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{up-env}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt′}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-conj-L}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaBound{lt₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-conj-R1}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-conj-R2}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₃}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v₃}\AgdaSymbol{)\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{N2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{N3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-dist}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{N2}\AgdaSpace{}%
\AgdaBound{N3}\<%
\\
\>[0]\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-trans}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSpace{}%
\AgdaBound{x₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{x₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x₁}\<%
\end{code}
\end{fence}

With this subsumption property in hand, we can prove the forward
direction of the semantic equation for lambda. The proof is by induction
on the semantics, using \texttt{sub-ℱ} in the case for the \texttt{sub}
rule.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[217I]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[217I]%
\>[4]\AgdaComment{------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0]\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
\>[0]\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub-ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\end{code}
\end{fence}

The ``inversion lemma'' for lambda abstraction is a special case of the
above. The inversion lemma is useful in proving that denotations are
preserved by reduction.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lambda-inversion}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}\{}\AgdaBound{v₁}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[267I]\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₂}\<%
\\
\>[.][@{}l@{}]\<[267I]%
\>[4]\AgdaComment{-----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{↓}}\AgdaSpace{}%
\AgdaBound{v₂}\<%
\\
\>[0]\AgdaFunction{lambda-inversion}\AgdaSymbol{\{}\AgdaArgument{v₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSymbol{\}\{}\AgdaArgument{v₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ℰƛ→ℱℰ}\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d}\<%
\end{code}
\end{fence}

The backward direction of the semantic equation for lambda is even
easier to prove than the forward direction. We proceed by induction on
the value v.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[307I]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[307I]%
\>[4]\AgdaComment{------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\<%
\\
\>[0]\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-intro}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0]\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{d2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaBound{d2}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

So indeed, the denotational semantics is compositional with respect to
lambda abstraction, as witnessed by the function \texttt{ℱ}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lam-equiv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{lam-equiv}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{ℰƛ→ℱℰ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{ℱℰ→ℰƛ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

\hypertarget{equation-for-function-application}{%
\section{Equation for function
application}\label{equation-for-function-application}}

Next we fill in the ellipses for the equation concerning function
application.

\begin{myDisplay}
ℰ (M · N) ≃ ... ℰ M ... ℰ N ...
\end{myDisplay}

For this we need to define a function that takes two denotations, both
in context \texttt{Γ}, and produces another one in context \texttt{Γ}.
This function, let us name it \texttt{●}, needs to mimic the
non-recursive aspects of the semantics of an application
\texttt{L\ ·\ M}. We cannot proceed as easily as for \texttt{ℱ} and
define the function by recursion on value \texttt{v} because, for
example, the rule \texttt{↦-elim} applies to any value. Instead we shall
define \texttt{●} in a way that directly deals with the \texttt{↦-elim}
and \texttt{⊥-intro} rules but ignores \texttt{⊔-intro}. This makes the
forward direction of the proof more difficult, and the case for
\texttt{⊔-intro} demonstrates why the \texttt{⊑-dist} rule is important.

So we define the application of \texttt{D₁} to \texttt{D₂}, written
\texttt{D₁\ ●\ D₂}, to include any value \texttt{w} equivalent to
\texttt{⊥}, for the \texttt{⊥-intro} rule, and to include any value
\texttt{w} that is the output of an entry \texttt{v\ ↦\ w} in
\texttt{D₁}, provided the input \texttt{v} is in \texttt{D₂}, for the
\texttt{↦-elim} rule.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{7}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}●\AgdaUnderscore{}}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}●\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
\>[0]\AgdaSymbol{(}\AgdaBound{D₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊎}}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSymbol{(}\AgdaSpace{}%
\AgdaBound{D₁}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{)}\<%
\end{code}
\end{fence}

If one squints hard enough, the \texttt{\_●\_} operator starts to look
like the \texttt{apply} operation familiar to functional programmers. It
takes two parameters and applies the first to the second.

Next we consider the inversion lemma for application, which is also the
forward direction of the semantic equation for application. We describe
the proof below.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[420I]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[420I]%
\>[4]\AgdaComment{----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{↦-elim}\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-bot}\<%
\\
\>[0]\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSymbol{\}\{}\AgdaArgument{w}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaBound{d₂}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{lt1}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{lt2}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-conj-L}\AgdaSpace{}%
\AgdaBound{lt1}\AgdaSpace{}%
\AgdaBound{lt2}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[481I]\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{lt1}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[481I]%
\>[6]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaFunction{lt}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
%
\>[6]\AgdaKeyword{where}%
\>[506I]\AgdaFunction{lt}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₂}\<%
\\
\>[.][@{}l@{}]\<[506I]%
\>[12]\AgdaFunction{lt}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-fun}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-conj-L}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-trans}\AgdaSpace{}%
\AgdaBound{lt1}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-bot}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[526I]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{lt2}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[526I]%
\>[6]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaFunction{lt}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
%
\>[6]\AgdaKeyword{where}%
\>[551I]\AgdaFunction{lt}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{v₁}\<%
\\
\>[.][@{}l@{}]\<[551I]%
\>[12]\AgdaFunction{lt}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-fun}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-conj-L}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-trans}\AgdaSpace{}%
\AgdaBound{lt2}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-bot}\AgdaSymbol{)))}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[571I]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{L↓v12′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[571I]%
\>[6]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{L↓⊔}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaBound{L↓v12′}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[6]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{M↓⊔}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaBound{M↓v3′}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[6]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{v₁′′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{L↓⊔}\AgdaSpace{}%
\AgdaFunction{⊔↦⊔-dist}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓⊔}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{lt2}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-trans}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaBound{lt2}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[633I]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[633I]%
\>[6]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{L↓v12}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊑-fun}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{M↓v3}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

We proceed by induction on the semantics.

\begin{itemize}
\item
  In case \texttt{↦-elim} we have \texttt{γ\ ⊢\ L\ ↓\ (v′\ ↦\ v)} and
  \texttt{γ\ ⊢\ M\ ↓\ v′}, which is all we need to show
  \texttt{(ℰ\ L\ ●\ ℰ\ M)\ γ\ v}.
\item
  In case \texttt{⊥-intro} we have \texttt{v\ =\ ⊥}. We conclude that
  \texttt{v\ ⊑\ ⊥}.
\item
  In case \texttt{⊔-intro} we have \texttt{ℰ\ (L\ ·\ M)\ γ\ v₁} and
  \texttt{ℰ\ (L\ ·\ M)\ γ\ v₂} and need to show
  \texttt{(ℰ\ L\ ●\ ℰ\ M)\ γ\ (v₁\ ⊔\ v₂)}. By the induction hypothesis,
  we have \texttt{(ℰ\ L\ ●\ ℰ\ M)\ γ\ v₁} and
  \texttt{(ℰ\ L\ ●\ ℰ\ M)\ γ\ v₂}. We have four subcases to consider.

  \begin{itemize}
  \item
    Suppose \texttt{v₁\ ⊑\ ⊥} and \texttt{v₂\ ⊑\ ⊥}. Then
    \texttt{v₁\ ⊔\ v₂\ ⊑\ ⊥}.
  \item
    Suppose \texttt{v₁\ ⊑\ ⊥}, \texttt{γ\ ⊢\ L\ ↓\ v₁′\ ↦\ v₂}, and
    \texttt{γ\ ⊢\ M\ ↓\ v₁′}. We have
    \texttt{γ\ ⊢\ L\ ↓\ v₁′\ ↦\ (v₁\ ⊔\ v₂)} by rule \texttt{sub}
    because \texttt{v₁′\ ↦\ (v₁\ ⊔\ v₂)\ ⊑\ v₁′\ ↦\ v₂}.
  \item
    Suppose \texttt{γ\ ⊢\ L\ ↓\ v₁′\ ↦\ v₁}, \texttt{γ\ ⊢\ M\ ↓\ v₁′},
    and \texttt{v₂\ ⊑\ ⊥}. We have
    \texttt{γ\ ⊢\ L\ ↓\ v₁′\ ↦\ (v₁\ ⊔\ v₂)} by rule \texttt{sub}
    because \texttt{v₁′\ ↦\ (v₁\ ⊔\ v₂)\ ⊑\ v₁′\ ↦\ v₁}.
  \item
    Suppose \texttt{γ\ ⊢\ L\ ↓\ v₁′′\ ↦\ v₁,\ γ\ ⊢\ M\ ↓\ v₁′′},
    \texttt{γ\ ⊢\ L\ ↓\ v₁′\ ↦\ v₂}, and \texttt{γ\ ⊢\ M\ ↓\ v₁′}. This
    case is the most interesting. By two uses of the rule
    \texttt{⊔-intro} we have
    \texttt{γ\ ⊢\ L\ ↓\ (v₁′\ ↦\ v₂)\ ⊔\ (v₁′′\ ↦\ v₁)} and
    \texttt{γ\ ⊢\ M\ ↓\ (v₁′\ ⊔\ v₁′′)}. But this does not yet match
    what we need for \texttt{ℰ\ L\ ●\ ℰ\ M} because the result of
    \texttt{L} must be an \texttt{↦} whose input entry is
    \texttt{v₁′\ ⊔\ v₁′′}. So we use the \texttt{sub} rule to obtain
    \texttt{γ\ ⊢\ L\ ↓\ (v₁′\ ⊔\ v₁′′)\ ↦\ (v₁\ ⊔\ v₂)}, using the
    \texttt{⊔↦⊔-dist} lemma (thanks to the \texttt{⊑-dist} rule) to show
    that

    \begin{myDisplay}
      (v₁′ ⊔ v₁′′) ↦ (v₁ ⊔ v₂) ⊑ (v₁′ ↦ v₂) ⊔ (v₁′′ ↦ v₁)
    \end{myDisplay}

    So we have proved what is needed for this case.
  \end{itemize}
\item
  In case \texttt{sub} we have \texttt{Γ\ ⊢\ L\ ·\ M\ ↓\ v₁} and
  \texttt{v\ ⊑\ v₁}. By the induction hypothesis, we have
  \texttt{(ℰ\ L\ ●\ ℰ\ M)\ γ\ v₁}. We have two subcases to consider.

  \begin{itemize}
  \tightlist
  \item
    Suppose \texttt{v₁\ ⊑\ ⊥}. We conclude that \texttt{v\ ⊑\ ⊥}.
  \item
    Suppose \texttt{Γ\ ⊢\ L\ ↓\ v′\ →\ v₁} and \texttt{Γ\ ⊢\ M\ ↓\ v′}.
    We conclude with \texttt{Γ\ ⊢\ L\ ↓\ v′\ →\ v} by rule \texttt{sub},
    because \texttt{v′\ →\ v\ ⊑\ v′\ →\ v₁}.
  \end{itemize}
\end{itemize}

The forward direction is proved by cases on the premise
\texttt{(ℰ\ L\ ●\ ℰ\ M)\ γ\ v}. In case \texttt{v\ ⊑\ ⊥}, we obtain
\texttt{Γ\ ⊢\ L\ ·\ M\ ↓\ ⊥} by rule \texttt{⊥-intro}. Otherwise, we
conclude immediately by rule \texttt{↦-elim}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{●ℰ→ℰ·}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[667I]\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[667I]%
\>[4]\AgdaComment{----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\AgdaFunction{●ℰ→ℰ·}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaBound{lt}\<%
\\
\>[0]\AgdaFunction{●ℰ→ℰ·}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{d2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{↦-elim}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSpace{}%
\AgdaBound{d2}\<%
\end{code}
\end{fence}

So we have proved that the semantics is compositional with respect to
function application, as witnessed by the \texttt{●} function.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{app-equiv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{app-equiv}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{ℰ·→●ℰ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{●ℰ→ℰ·}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

We also need an inversion lemma for variables. If
\texttt{Γ\ ⊢\ x\ ↓\ v}, then \texttt{v\ ⊑\ γ\ x}. The proof is a
straightforward induction on the semantics.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[736I]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[.][@{}l@{}]\<[736I]%
\>[4]\AgdaComment{-------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊑-refl}\<%
\\
\>[0]\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊔-intro}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-conj-L}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaBound{d₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaBound{d₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-trans}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥-intro}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊑-bot}\<%
\end{code}
\end{fence}

To round-out the semantic equations, we establish the following one for
variables.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{var-equiv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{var-equiv}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{var-inv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

\hypertarget{congruence}{%
\section{Congruence}\label{congruence}}

The main work of this chapter is complete: we have established semantic
equations that show how the denotational semantics is compositional. In
this section and the next we make use of these equations to prove some
corollaries: that denotational equality is a \emph{congruence} and to
prove the \emph{compositionality property}, which states that
surrounding two denotationally-equal terms in the same context produces
two programs that are denotationally equal.

We begin by showing that denotational equality is a congruence with
respect to lambda abstraction: that \texttt{ℰ\ N\ ≃\ ℰ\ N′} implies
\texttt{ℰ\ (ƛ\ N)\ ≃\ ℰ\ (ƛ\ N′)}. We shall use the \texttt{lam-equiv}
equation to reduce this question to whether \texttt{ℱ} is a congruence.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ℱ-cong}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{D′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[808I]\AgdaBound{D}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaBound{D′}\<%
\\
\>[.][@{}l@{}]\<[808I]%
\>[4]\AgdaComment{-----------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D′}\<%
\\
\>[0]\AgdaFunction{ℱ-cong}\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{D≃D′}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ≃}\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{D≃D′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ≃}\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≃-sym}\AgdaSpace{}%
\AgdaBound{D≃D′}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
%
\>[2]\AgdaKeyword{where}\<%
\\
%
\>[2]\AgdaFunction{ℱ≃}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}\{}\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{D′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}%
\>[15]\AgdaSymbol{→}%
\>[18]\AgdaBound{D}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaBound{D′}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaBound{D′}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaFunction{ℱ≃}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊥}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{fd}\AgdaSpace{}%
\AgdaBound{dd′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
%
\>[2]\AgdaFunction{ℱ≃}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{fd}\AgdaSpace{}%
\AgdaBound{dd′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{dd′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{`,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{fd}\<%
\\
%
\>[2]\AgdaFunction{ℱ≃}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{u}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊔}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{fd}\AgdaSpace{}%
\AgdaBound{dd′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaFunction{ℱ≃}\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{u}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{fd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{dd′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{ℱ≃}\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}\{}\AgdaBound{w}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{fd}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{dd′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

The proof of \texttt{ℱ-cong} uses the lemma \texttt{ℱ≃} to handle both
directions of the if-and-only-if. That lemma is proved by a
straightforward induction on the value \texttt{v}.

We now prove that lambda abstraction is a congruence by direct
equational reasoning.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lam-cong}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{N′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[903I]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N′}\<%
\\
\>[.][@{}l@{}]\<[903I]%
\>[4]\AgdaComment{-----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{lam-cong}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSymbol{\}\{}\AgdaBound{N′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{N≃N′}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaFunction{start}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{lam-equiv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{ℱ-cong}\AgdaSpace{}%
\AgdaBound{N≃N′}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N′}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{≃-sym}\AgdaSpace{}%
\AgdaFunction{lam-equiv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N′}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{☐}}\<%
\end{code}
\end{fence}

Next we prove that denotational equality is a congruence for
application: that \texttt{ℰ\ L\ ≃\ ℰ\ L′} and \texttt{ℰ\ M\ ≃\ ℰ\ M′}
imply \texttt{ℰ\ (L\ ·\ M)\ ≃\ ℰ\ (L′\ ·\ M′)}. The \texttt{app-equiv}
equation reduces this to the question of whether the \texttt{●} operator
is a congruence.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{●-cong}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{D₁}\AgdaSpace{}%
\AgdaBound{D₁′}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSpace{}%
\AgdaBound{D₂′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{D₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaBound{D₁′}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaBound{D₂′}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{D₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{D₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaBound{D₂′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{●-cong}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSpace{}%
\AgdaBound{d2}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}%
\>[963I]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{●≃}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSpace{}%
\AgdaBound{d2}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
\>[.][@{}l@{}]\<[963I]%
\>[25]\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{●≃}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≃-sym}\AgdaSpace{}%
\AgdaBound{d1}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≃-sym}\AgdaSpace{}%
\AgdaBound{d2}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{where}\<%
\\
%
\>[2]\AgdaFunction{●≃}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{v}\AgdaSymbol{\}\{}\AgdaBound{D₁}\AgdaSpace{}%
\AgdaBound{D₁′}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSpace{}%
\AgdaBound{D₂′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{D₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaBound{D₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}%
\>[21]\AgdaSymbol{→}%
\>[24]\AgdaBound{D₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaBound{D₁′}%
\>[34]\AgdaSymbol{→}%
\>[37]\AgdaBound{D₂}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaBound{D₂′}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{D₁′}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaBound{D₂′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaFunction{●≃}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{v⊑⊥}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eq₁}\AgdaSpace{}%
\AgdaBound{eq₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{inj₁}\AgdaSpace{}%
\AgdaBound{v⊑⊥}\<%
\\
%
\>[2]\AgdaFunction{●≃}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{w}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{Dv↦w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{Dv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{eq₁}\AgdaSpace{}%
\AgdaBound{eq₂}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{inj₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{eq₁}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{↦}}\AgdaSpace{}%
\AgdaBound{w}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{Dv↦w}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{eq₂}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{Dv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

Again, both directions of the if-and-only-if are proved via a lemma.
This time the lemma is proved by cases on \texttt{(D₁\ ●\ D₂)\ γ\ v}.

With the congruence of \texttt{●}, we can prove that application is a
congruence by direct equational reasoning.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{app-cong}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{L′}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L′}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[1060I]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
\>[.][@{}l@{}]\<[1060I]%
\>[4]\AgdaComment{-------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{app-cong}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{L}\AgdaSymbol{\}\{}\AgdaBound{L′}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{M′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{L≅L′}\AgdaSpace{}%
\AgdaBound{M≅M′}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaFunction{start}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{app-equiv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{●-cong}\AgdaSpace{}%
\AgdaBound{L≅L′}\AgdaSpace{}%
\AgdaBound{M≅M′}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L′}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{≃-sym}\AgdaSpace{}%
\AgdaFunction{app-equiv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{☐}}\<%
\end{code}
\end{fence}

\hypertarget{compositionality}{%
\section{Compositionality}\label{compositionality}}

The \emph{compositionality property} states that surrounding two terms
that are denotationally equal in the same context produces two programs
that are denotationally equal. To make this precise, we define what we
mean by ``context'' and ``surround''.

A \emph{context} is a program with one hole in it. The following data
definition \texttt{Ctx} makes this idea explicit. We index the
\texttt{Ctx} data type with two contexts for variables: one for the hole
and one for terms that result from filling the hole.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{ctx-hole}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
%
\>[2]\AgdaInductiveConstructor{ctx-lam}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[13]\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
%
\>[2]\AgdaInductiveConstructor{ctx-app-L}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
%
\>[2]\AgdaInductiveConstructor{ctx-app-R}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\end{code}
\end{fence}

\begin{itemize}
\item
  The constructor \texttt{ctx-hole} represents the hole, and in this
  case the variable context for the hole is the same as the variable
  context for the term that results from filling the hole.
\item
  The constructor \texttt{ctx-lam} takes a \texttt{Ctx} and produces a
  larger one that adds a lambda abstraction at the top. The variable
  context of the hole stays the same, whereas we remove one variable
  from the context of the resulting term because it is bound by this
  lambda abstraction.
\item
  There are two constructions for application, \texttt{ctx-app-L} and
  \texttt{ctx-app-R}. The \texttt{ctx-app-L} is for when the hole is
  inside the left-hand term (the operator) and the later is when the
  hole is inside the right-hand term (the operand).
\end{itemize}

The action of surrounding a term with a context is defined by the
following \texttt{plug} function. It is defined by recursion on the
context.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{plug}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\<%
\\
\>[0]\AgdaFunction{plug}\AgdaSpace{}%
\AgdaInductiveConstructor{ctx-hole}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
\>[0]\AgdaFunction{plug}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ctx-lam}\AgdaSpace{}%
\AgdaBound{C}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaFunction{plug}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[0]\AgdaFunction{plug}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ctx-app-L}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{plug}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[0]\AgdaFunction{plug}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ctx-app-R}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{C}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{plug}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

We are ready to state and prove the compositionality principle. Given
two terms \texttt{M} and \texttt{N} that are denotationally equal,
plugging them both into an arbitrary context \texttt{C} produces two
programs that are denotationally equal.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}\{}\AgdaBound{C}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[1220I]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[1220I]%
\>[4]\AgdaComment{---------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{plug}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{plug}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ctx-hole}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaBound{M≃N}\<%
\\
\>[0]\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ctx-lam}\AgdaSpace{}%
\AgdaBound{C′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaFunction{lam-cong}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ctx-app-L}\AgdaSpace{}%
\AgdaBound{C′}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaFunction{app-cong}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ctx-app-R}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{C′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaFunction{app-cong}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{compositionality}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{M≃N}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

The proof is a straightforward induction on the context \texttt{C},
using the congruence properties \texttt{lam-cong} and \texttt{app-cong}
that we established above.

\hypertarget{the-denotational-semantics-defined-as-a-function}{%
\section{The denotational semantics defined as a
function}\label{the-denotational-semantics-defined-as-a-function}}

Having established the three equations \texttt{var-equiv},
\texttt{lam-equiv}, and \texttt{app-equiv}, one should be able to define
the denotational semantics as a recursive function over the input term
\texttt{M}. Indeed, we define the following function \texttt{⟦\ M\ ⟧}
that maps terms to denotations, using the auxiliary curry \texttt{ℱ} and
apply \texttt{●} functions in the cases for lambda and application,
respectively.

\begin{fence}
\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{⟦\AgdaUnderscore{}⟧}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Denotation}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊑}}\AgdaSpace{}%
\AgdaBound{γ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\end{code}
\end{fence}

The proof that \texttt{ℰ\ M} is denotationally equal to \texttt{⟦\ M\ ⟧}
is a straightforward induction, using the three equations
\texttt{var-equiv}, \texttt{lam-equiv}, and \texttt{app-equiv} together
with the congruence lemmas for \texttt{ℱ} and \texttt{●}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{★}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≃}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\\
\>[0]\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{var-equiv}\<%
\\
\>[0]\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{ih}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{lam-equiv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{ℱ-cong}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{ℱ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{☐}}\<%
\\
\>[0]\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{app-equiv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaFunction{ℰ}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨}}\AgdaSpace{}%
\AgdaFunction{●-cong}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ℰ≃⟦⟧}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{●}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{≃⟨⟩}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{☐}}\<%
\end{code}
\end{fence}

\hypertarget{unicode}{%
\section{Unicode}\label{unicode}}

This chapter uses the following unicode:

\begin{myDisplay}
ℱ  U+2131  SCRIPT CAPITAL F (\McF)
●  U+2131  BLACK CIRCLE (\cib)
\end{myDisplay}


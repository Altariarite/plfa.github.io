\hypertarget{Subtyping}{%
\chapter{Subtyping: Records}\label{Subtyping}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{plfa.part2.Subtyping}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
\end{fence}

This chapter introduces \emph{subtyping}, a concept that plays an
important role in object-oriented languages. Subtyping enables code to
be more reusable by allowing it to work on objects of many different
types. Thus, subtyping provides a kind of polymorphism. In general, a
type \texttt{A} can be a subtype of another type \texttt{B}, written
\texttt{A\ \textless{}:\ B}, when an object of type \texttt{A} has all
the capabilities expected of something of type \texttt{B}. Or put
another way, a type \texttt{A} can be a subtype of type \texttt{B} when
it is safe to substitute something of type \texttt{A} into code that
expects something of type \texttt{B}. This is know as the \emph{Liskov
Substitution Principle}. Given this semantic meaning of subtyping, a
subtype relation should always be reflexive and transitive. When
\texttt{A} is a subtype of \texttt{B}, that is,
\texttt{A\ \textless{}:\ B}, we may also refer to \texttt{B} as a
supertype of \texttt{A}.

To formulate a type system for a language with subtyping, one simply
adds the \emph{subsumption rule}, which states that a term of type
\texttt{A} can also have type \texttt{B} if \texttt{A} is a subtype of
\texttt{B}.

\begin{myDisplay}
⊢<: : ∀{Γ M A B}
  → Γ ⊢ M ⦂ A
→ A <: B
    -----------
  → Γ ⊢ M ⦂ B
\end{myDisplay}

In this chapter we study subtyping in the relatively simple context of
records and record types. A \emph{record} is a grouping of named values,
called \emph{fields}. For example, one could represent a point on the
Cartesian plane with the following record.

\begin{myDisplay}
{ x = 4, y = 1 }
\end{myDisplay}

A \emph{record type} gives a type for each field. In the following, we
specify that the fields \texttt{x} and \texttt{y} both have type
\texttt{ℕ}.

\begin{myDisplay}
{ x : `ℕ,  y : `ℕ }
\end{myDisplay}

One record type is a subtype of another if it has all of the fields of
the supertype and if the types of those fields are subtypes of the
corresponding fields in the supertype. So, for example, a point in three
dimensions is a subtype of a point in two dimensions.

\begin{myDisplay}
{ x : `ℕ,  y : `ℕ, z : `ℕ } <: { x : `ℕ,  y : `ℕ }
\end{myDisplay}

The elimination form for records is field access (aka. projection),
written \texttt{M\ \#\ l}, and whose dynamic semantics is defined by the
following reduction rule, which says that accessing the field
\texttt{lⱼ} returns the value stored at that field.

\begin{myDisplay}
{l₁=v₁, ..., lⱼ=vⱼ, ..., lᵢ=vᵢ} # lⱼ —→  vⱼ
\end{myDisplay}

In this chapter we add records and record types to the simply typed
lambda calculus (STLC) and prove type safety. It is instructive to see
how the proof of type safety changes to handle subtyping. Also, the
presence of subtyping makes the choice between extrinsic and intrinsic
typing more interesting by. If we wish to include the subsumption rule,
then we cannot use intrinsically typed terms, as intrinsic terms only
allow for syntax-directed rules, and subsumption is not syntax directed.
A standard alternative to the subsumption rule is to instead use
subtyping in the typing rules for the elimination forms, an approach
called algorithmic typing. Here we choose to include the subsumption
rule and extrinsic typing, but we give an exercise at the end of the
chapter so the reader can explore algorithmic typing with intrinsic
terms.

\hypertarget{imports}{%
\section{Imports}\label{imports}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{⊥}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty.Irrelevant}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaFunction{⊥-elimi}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Fin}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Fin}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}≤\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}<\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat.Properties}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{m+n≤o⇒m≤o}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{m+n≤o⇒n≤o}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{n≤0⇒n≡0}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{≤-pred}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{≤-refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{≤-trans}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{m≤m+n}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{n≤m+n}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}×\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{Σ-syntax}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨\AgdaUnderscore{},\AgdaUnderscore{}⟩}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.String}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaPostulate{String}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}≟\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaRecord{⊤}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Vec}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Vec}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Vec.Membership.Propositional}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}∈\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Vec.Membership.DecPropositional}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}≟\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaUnderscore{}∈?\AgdaUnderscore{}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Vec.Membership.Propositional.Properties}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{∈-lookup}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Vec.Relation.Unary.Any}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{here}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{there}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{Eq}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Eq}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}≡\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{sym}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{trans}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaRecord{Dec}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{¬\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

\hypertarget{syntax}{%
\section{Syntax}\label{syntax}}

The syntax includes that of the STLC with a few additions regarding
records that we explain in the following sections.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⊆\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}<:\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢*\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}∋\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{Canonical\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{infixr}\AgdaSpace{}%
\AgdaNumber{7}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⇒\AgdaUnderscore{}}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{ƛ\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{μ\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{7}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}·\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{8}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`suc\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}%
\>[7]\AgdaNumber{9}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{7}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}\#\AgdaUnderscore{}}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛\AgdaUnderscore{}⦂\AgdaUnderscore{}｝}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛\AgdaUnderscore{}:=\AgdaUnderscore{}｝}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}[\AgdaUnderscore{}]}}\<%
\\
\>[0]\AgdaKeyword{infix}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}—→\AgdaUnderscore{}}}\<%
\end{code}
\end{fence}

\hypertarget{record-fields-and-their-properties}{%
\section{Record Fields and their
Properties}\label{record-fields-and-their-properties}}

We represent field names as strings.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{Name}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaFunction{Name}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\end{code}
\end{fence}

A record is traditionally written as follows

\begin{myDisplay}
{ l₁ = M₁, ..., lᵢ = Mᵢ }
\end{myDisplay}

so a natural representation is a list of label-term pairs. However, we
find it more convenient to represent records as a pair of vectors
(Agda's \texttt{Vec} type), one vector of fields and one vector of
terms:

\begin{myDisplay}
l₁, ..., lᵢ
M₁, ..., Mᵢ
\end{myDisplay}

This representation has the advantage that the traditional subscript
notation \texttt{lᵢ} corresponds to indexing into a vector.

Likewise, a record type, traditionally written as

\begin{myDisplay}
{ l₁ : A₁, ..., lᵢ : Aᵢ }
\end{myDisplay}

will be represented as a pair of vectors, one vector of fields and one
vector of types.

\begin{myDisplay}
l₁, ..., lᵢ
A₁, ..., Aᵢ
\end{myDisplay}

The field names of a record type must be distinct, which we define as
follows.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSymbol{\}\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
\>[0]\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∈}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{xs}\<%
\end{code}
\end{fence}

For vectors of distinct elements, lookup is injective.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{ls}%
\>[18]\AgdaSymbol{→}%
\>[21]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{j}\<%
\\
%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{j}\<%
\\
\>[0]\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{x∉ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaBound{lsij}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{x∉ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x∉ls}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{∈-lookup}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{x∉ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x∉ls}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{∈-lookup}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{x∉ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaBound{lsij}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSpace{}%
\AgdaBound{lsij}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

We shall need to convert from an irrelevant proof of distinctness to a
relevant one. In general, the laundering of irrelevant proofs into
relevant ones is easy to do when the predicate in question is decidable.
The following is a decision procedure for whether a vector is distinct.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{distinct?}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{xs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaRecord{Dec}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{distinct?}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
\>[0]\AgdaFunction{distinct?}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∈?}}\AgdaSpace{}%
\AgdaBound{xs}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaBound{x∈xs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaBound{x∈xs}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[288I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaBound{x∉xs}\<%
\\
\>[.][@{}l@{}]\<[288I]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{distinct?}\AgdaSpace{}%
\AgdaBound{xs}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaBound{dxs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{x∉xs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{dxs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaBound{¬dxs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{¬dxs}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₂}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

With this decision procedure in hand, we define the following function
for laundering irrelevant proofs of distinctness into relevant ones.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{distinct-relevant}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{fs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{.(}\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{fs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{fs}\<%
\\
\>[0]\AgdaFunction{distinct-relevant}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{fs}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{d}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{distinct?}\AgdaSpace{}%
\AgdaBound{fs}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{yes}\AgdaSpace{}%
\AgdaBound{dfs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{dfs}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{no}\AgdaSpace{}%
\AgdaBound{¬dfs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elimi}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{¬dfs}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

The fields of one record are a \emph{subset} of the fields of another
record if every field of the first is also a field of the second.

\begin{fence}
\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⊆\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaBound{xs}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ys}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∈}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∈}}\AgdaSpace{}%
\AgdaBound{ys}\<%
\end{code}
\end{fence}

This subset relation is reflexive and transitive.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{⊆-refl}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ls}\<%
\\
\>[0]\AgdaFunction{⊆-refl}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{x∈ls}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x∈ls}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{⊆-trans}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{ns}%
\>[23]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ms}%
\>[41]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{ls}%
\>[59]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ms}%
\>[14]\AgdaSymbol{→}%
\>[17]\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ls}%
\>[26]\AgdaSymbol{→}%
\>[29]\AgdaBound{ns}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ls}\<%
\\
\>[0]\AgdaFunction{⊆-trans}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{l}\AgdaSymbol{\}\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{ns}\AgdaSymbol{\}\{}\AgdaBound{ms}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ns⊆ms}\AgdaSpace{}%
\AgdaBound{ms⊆ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ms⊆ls}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ns⊆ms}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

If \texttt{y} is an element of vector \texttt{xs}, then \texttt{y} is at
some index \texttt{i} of the vector.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lookup-∈}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{ℓ}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaBound{ℓ}\AgdaSymbol{\}\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{xs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{y}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∈}}\AgdaSpace{}%
\AgdaBound{xs}\<%
\\
%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{y}\<%
\\
\>[0]\AgdaFunction{lookup-∈}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{xs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{here}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{lookup-∈}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{xs}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{there}\AgdaSpace{}%
\AgdaBound{y∈xs}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{lookup-∈}\AgdaSpace{}%
\AgdaBound{y∈xs}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{xs[i]=y}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{xs[i]=y}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\end{code}
\end{fence}

If one vector \texttt{ns} is a subset of another \texttt{ms}, then for
any element \texttt{lookup\ ns\ i}, there is an equal element in
\texttt{ms} at some index.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}\{}\AgdaBound{ns}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ms}\<%
\\
%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Σ[}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaFunction{∈}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaFunction{]}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaBound{k}\<%
\\
\>[0]\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ms}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ns⊆ms}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{lookup-∈}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ns⊆ms}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{here}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[527I]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ms[k]=x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[527I]%
\>[6]\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{ms[k]=x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[0]\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ms}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{x∷ns⊆ms}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ns}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ms}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{x∷ns⊆ms}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{there}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{))}\<%
\end{code}
\end{fence}

\hypertarget{types}{%
\section{Types}\label{types}}

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⇒\AgdaUnderscore{}}}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\<%
\\
%
\>[2]\AgdaInductiveConstructor{`ℕ}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Type}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{｛\AgdaUnderscore{}⦂\AgdaUnderscore{}｝}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{.\{}\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\<%
\end{code}
\end{fence}

In addition to function types \texttt{A\ ⇒\ B} and natural numbers
\texttt{ℕ}, we have the record type \texttt{｛\ ls\ ⦂\ As\ ｝}, where
\texttt{ls} is a vector of field names and \texttt{As} is a vector of
types, as discussed above. We require that the field names be distinct,
but we do not want the details of the proof of distinctness to affect
whether two record types are equal, so we declare that parameter to be
irrelevant by placing a \texttt{.} in front of it.

\hypertarget{subtyping}{%
\section{Subtyping}\label{subtyping}}

The subtyping relation, written \texttt{A\ \textless{}:\ B}, defines
when an implicit cast is allowed via the subsumption rule. The following
data type definition specifies the subtyping rules for natural numbers,
functions, and record types. We discuss each rule below.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}<:\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{<:-nat}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{D}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[612I]\AgdaBound{C}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{A}%
\>[14]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{D}\<%
\\
\>[.][@{}l@{}]\<[612I]%
\>[6]\AgdaComment{----------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{D}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[12]\AgdaSymbol{∀\{}\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{ks}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{Ss}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}.\{}\AgdaBound{d1}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSymbol{\}}\<%
\\
\>[12][@{}l@{\AgdaIndent{0}}]%
\>[13]\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Ts}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}.\{}\AgdaBound{d2}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊆}}\AgdaSpace{}%
\AgdaBound{ks}\<%
\\
%
\>[4]\AgdaSymbol{→}%
\>[651I]\AgdaSymbol{(∀\{}\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}}%
\>[658I]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
\>[.][@{}l@{}]\<[658I]%
\>[31]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{Ss}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{Ts}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[651I]%
\>[6]\AgdaComment{------------------------------------------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{Ss}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{d1}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{Ts}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{d2}\AgdaSymbol{\}}\<%
\end{code}
\end{fence}

The rule \texttt{\textless{}:-nat} says that \texttt{ℕ} is a subtype of
itself.

The rule \texttt{\textless{}:-fun} is the traditional rule for function
types, which is best understood with the below diagram. It answers the
question, when can a function of type \texttt{A\ ⇒\ B} be used in place
of a function of type \texttt{C\ ⇒\ D}. It will be called with an
argument of type \texttt{C}, so we need to convert from \texttt{C} to
\texttt{A}. We then call the function to get the result of type
\texttt{B}. Finally, we need to convert from \texttt{B} to \texttt{D}.
Note that the direction of subtyping for the parameters is swapped
(\texttt{C\ \textless{}:\ A}), a phenomenon named contra-variance.

\begin{myDisplay}
C <: A
⇓    ⇓
D :> B
\end{myDisplay}

The record subtyping rule (\texttt{\textless{}:-rcd}) characterizes when
a record of one type can safely be used in place of another record type.
The first premise of the rule expresses \emph{width subtyping} by
requiring that all the field names in \texttt{ls} are also in
\texttt{ks}. So it allows the hiding of fields when going from a subtype
to a supertype. The second premise of the record subtyping rule
(\texttt{\textless{}:-rcd}) expresses \emph{depth subtyping}, that is,
it allows the types of the fields to change according to subtyping. The
following is an abbreviation for this premise.

\begin{fence}
\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⦂\AgdaUnderscore{}<:\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⦂\AgdaUnderscore{}<:\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSpace{}%
\AgdaBound{Ss}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{Ts}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(∀\{}\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{i}%
\>[33]\AgdaSymbol{→}%
\>[36]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{Ss}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{Ts}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

\hypertarget{subtyping-is-reflexive}{%
\section{Subtyping is Reflexive}\label{subtyping-is-reflexive}}

In this section we prove that subtyping is reflexive, that is,
\texttt{A\ \textless{}:\ A} for any type \texttt{A}. The proof does not
go by induction on the type \texttt{A} because of the
\texttt{\textless{}:-rcd} rule. We instead use induction on the size of
the type. So we first define size of a type, and the size of a vector of
types, as follows.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
\>[0]\AgdaFunction{vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaNumber{1}\<%
\\
\>[0]\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{vec-ty-size}\AgdaSpace{}%
\AgdaBound{As}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
\>[0]\AgdaFunction{vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{xs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaFunction{vec-ty-size}\AgdaSpace{}%
\AgdaBound{xs}\<%
\end{code}
\end{fence}

The size of a type is always positive.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ty-size-pos}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<}}\AgdaSpace{}%
\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{ty-size-pos}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{ty-size-pos}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`ℕ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\\
\>[0]\AgdaFunction{ty-size-pos}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{fs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{s≤s}\AgdaSpace{}%
\AgdaInductiveConstructor{z≤n}\<%
\end{code}
\end{fence}

The size of a type in a vector is less-or-equal in size to the entire
vector.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{lookup-vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{j}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤}}\AgdaSpace{}%
\AgdaFunction{vec-ty-size}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
\>[0]\AgdaFunction{lookup-vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{m≤m+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
\>[0]\AgdaFunction{lookup-vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{≤-trans}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lookup-vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{As}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{n≤m+n}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\<%
\end{code}
\end{fence}

Here is the proof of reflexivity, by induction on the size of the type.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≤}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaNumber{0}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{m}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{ty-size-pos}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[870I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{pos}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{n≤0⇒n≡0}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
\>[.][@{}l@{}]\<[870I]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{pos}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaInductiveConstructor{`ℕ}\AgdaSymbol{\}\{}\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{<:-nat}\<%
\\
\>[0]\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}\{}\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{A<:A}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaFunction{m+n≤o⇒m≤o}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≤-pred}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[2]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{B<:B}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{B}\AgdaSymbol{\}\{}\AgdaFunction{m+n≤o⇒n≤o}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≤-pred}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[2]\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaBound{A<:A}\AgdaSpace{}%
\AgdaBound{B<:B}\<%
\\
\>[0]\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\}\{}\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d1}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}\{}\AgdaArgument{d2}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaFunction{⊆-refl}\AgdaSpace{}%
\AgdaFunction{G}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{where}\<%
\\
%
\>[4]\AgdaFunction{G}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<:}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
%
\>[4]\AgdaFunction{G}%
\>[932I]\AgdaSymbol{\{}\AgdaBound{i}\AgdaSymbol{\}\{}\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{lij}\AgdaSpace{}%
\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{distinct-relevant}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lij}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[932I][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{As[i]≤n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{≤-trans}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lookup-vec-ty-size}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{As}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{As}\AgdaSymbol{\}\{}\AgdaBound{i}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{≤-pred}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[8]\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}\{}\AgdaBound{As[i]≤n}\AgdaSymbol{\}}\<%
\end{code}
\end{fence}

The theorem statement uses \texttt{n} as an upper bound on the size of
the type \texttt{A} and proceeds by induction on \texttt{n}.

\begin{itemize}
\item
  If it is \texttt{0}, then we have a contradiction because the size of
  a type is always positive.
\item
  If it is \texttt{suc\ n}, we proceed by cases on the type \texttt{A}.

  \begin{itemize}
  \tightlist
  \item
    If it is \texttt{ℕ}, then we have \texttt{ℕ\ \textless{}:\ ℕ} by
    rule \texttt{\textless{}:-nat}.
  \item
    If it is \texttt{A\ ⇒\ B}, then by induction we have
    \texttt{A\ \textless{}:\ A} and \texttt{B\ \textless{}:\ B}. We
    conclude that \texttt{A\ ⇒\ B\ \textless{}:\ A\ ⇒\ B} by rule
    \texttt{\textless{}:-fun}.
  \item
    If it is \texttt{｛\ ls\ ⦂\ As\ ｝}, then it suffices to prove that
    \texttt{ls\ ⊆\ ls} and \texttt{ls\ ⦂\ As\ \textless{}:\ ls\ ⦂\ As}.
    The former is proved by \texttt{⊆-refl}. Regarding the latter, we
    need to show that for any \texttt{i} and \texttt{j},
    \texttt{lookup\ ls\ j\ ≡\ lookup\ ls\ i} implies
    \texttt{lookup\ As\ j\ \textless{}:\ lookup\ As\ i}. Because
    \texttt{lookup} is injective on distinct vectors, we have
    \texttt{i\ ≡\ j}. We then use the induction hypothesis to show that
    \texttt{lookup\ As\ i\ \textless{}:\ lookup\ As\ i}, noting that the
    size of \texttt{lookup\ As\ i} is less-than-or-equal to the size of
    \texttt{As}, which is one smaller than the size of
    \texttt{｛\ ls\ ⦂\ As\ ｝}.
  \end{itemize}
\end{itemize}

The following corollary packages up reflexivity for ease of use.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{<:-refl}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{<:-refl}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{<:-refl-aux}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaFunction{ty-size}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaFunction{≤-refl}\AgdaSymbol{\}}\<%
\end{code}
\end{fence}

\hypertarget{subtyping-is-transitive}{%
\section{Subtyping is transitive}\label{subtyping-is-transitive}}

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaBound{C}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[968I]\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{B}%
\>[15]\AgdaSymbol{→}%
\>[19]\AgdaBound{B}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{C}\<%
\\
\>[.][@{}l@{}]\<[968I]%
\>[6]\AgdaComment{-------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{C}\<%
\\
\>[0]\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{A₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{B₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{C₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{C₂}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaBound{A₁<:B₁}\AgdaSpace{}%
\AgdaBound{A₂<:B₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaBound{B₁<:C₁}\AgdaSpace{}%
\AgdaBound{B₂<:C₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaBound{B₁<:C₁}\AgdaSpace{}%
\AgdaBound{A₁<:B₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaBound{A₂<:B₂}\AgdaSpace{}%
\AgdaBound{B₂<:C₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{`ℕ}}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`ℕ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaDottedPattern{\AgdaSymbol{.}}\AgdaDottedPattern{\AgdaInductiveConstructor{`ℕ}}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{<:-nat}\AgdaSpace{}%
\AgdaInductiveConstructor{<:-nat}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{<:-nat}\<%
\\
\>[0]\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSymbol{\{}\AgdaBound{d1}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{Bs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{d2}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{Cs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{d3}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{(}\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaBound{ms⊆ls}\AgdaSpace{}%
\AgdaBound{As<:Bs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaBound{ns⊆ms}\AgdaSpace{}%
\AgdaBound{Bs<:Cs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
%
\>[4]\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{⊆-trans}\AgdaSpace{}%
\AgdaBound{ns⊆ms}\AgdaSpace{}%
\AgdaBound{ms⊆ls}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaFunction{As<:Cs}\<%
\\
%
\>[4]\AgdaKeyword{where}\<%
\\
%
\>[4]\AgdaFunction{As<:Cs}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<:}}\AgdaSpace{}%
\AgdaBound{ns}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{Cs}\<%
\\
%
\>[4]\AgdaFunction{As<:Cs}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{i}\AgdaSymbol{\}\{}\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ls[j]=ns[i]}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ns⊆ms}\<%
\\
%
\>[4]\AgdaSymbol{...}%
\>[1050I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ns[i]=ms[k]}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[1050I]%
\>[8]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{As[j]<:Bs[k]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{As<:Bs}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{k}\AgdaSymbol{\}\{}\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{trans}\AgdaSpace{}%
\AgdaBound{ls[j]=ns[i]}\AgdaSpace{}%
\AgdaBound{ns[i]=ms[k]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[8]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{Bs[k]<:Cs[i]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Bs<:Cs}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{i}\AgdaSymbol{\}\{}\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{ns[i]=ms[k]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[8]\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaBound{As[j]<:Bs[k]}\AgdaSpace{}%
\AgdaBound{Bs[k]<:Cs[i]}\<%
\end{code}
\end{fence}

The proof is by induction on the derivations of
\texttt{A\ \textless{}:\ B} and \texttt{B\ \textless{}:\ C}.

\begin{itemize}
\item
  If both derivations end with \texttt{\textless{}:-nat}: then we
  immediately conclude that \texttt{ℕ\ \textless{}:\ ℕ}.
\item
  If both derivations end with \texttt{\textless{}:-fun}: we have
  \texttt{A₁\ ⇒\ A₂\ \textless{}:\ B₁\ ⇒\ B₂} and
  \texttt{B₁\ ⇒\ B₂\ \textless{}:\ C₁\ ⇒\ C₂}. So
  \texttt{A₁\ \textless{}:\ B₁} and \texttt{B₁\ \textless{}:\ C₁}, thus
  \texttt{A₁\ \textless{}:\ C₁} by the induction hypothesis. We also
  have \texttt{A₂\ \textless{}:\ B₂} and \texttt{B₂\ \textless{}:\ C₂},
  so by the induction hypothesis we have \texttt{A₂\ \textless{}:\ C₂}.
  We conclude that \texttt{A₁\ ⇒\ A₂\ \textless{}:\ C₁\ ⇒\ C₂} by rule
  \texttt{\textless{}:-fun}.
\item
  If both derivations end with \texttt{\textless{}:-rcd}, so we have
  \texttt{｛\ ls\ ⦂\ As\ ｝\ \textless{}:\ ｛\ ms\ ⦂\ Bs\ ｝} and
  \texttt{｛\ ms\ ⦂\ Bs\ ｝\ \textless{}:\ ｛\ ns\ ⦂\ Cs\ ｝}. From
  \texttt{ls\ ⊆\ ms} and \texttt{ms\ ⊆\ ns} we have \texttt{ls\ ⊆\ ns}
  because \texttt{⊆} is transitive. Next we need to prove that
  \texttt{ls\ ⦂\ As\ \textless{}:\ ns\ ⦂\ Cs}. Suppose
  \texttt{lookup\ ls\ j\ ≡\ lookup\ ns\ i} for an arbitrary \texttt{i}
  and \texttt{j}. We need to prove that
  \texttt{lookup\ As\ j\ \textless{}:\ lookup\ Cs\ i}. By the induction
  hypothesis, it suffices to show that
  \texttt{lookup\ As\ j\ \textless{}:\ lookup\ Bs\ k} and
  \texttt{lookup\ Bs\ k\ \textless{}:\ lookup\ Cs\ i} for some
  \texttt{k}. We can obtain the former from
  \texttt{｛\ ls\ ⦂\ As\ ｝\ \textless{}:\ ｛\ ms\ ⦂\ Bs\ ｝} if we can
  prove that \texttt{lookup\ ls\ j\ ≡\ lookup\ ms\ k}. We already have
  \texttt{lookup\ ls\ j\ ≡\ lookup\ ns\ i} and we obtain
  \texttt{lookup\ ns\ i\ ≡\ lookup\ ms\ k} by use of the lemma
  \texttt{lookup-⊆}, noting that \texttt{ns\ ⊆\ ms}. We can obtain the
  later, that \texttt{lookup\ Bs\ k\ \textless{}:\ lookup\ Cs\ i}, from
  \texttt{｛\ ms\ ⦂\ Bs\ ｝\ \textless{}:\ ｛\ ns\ ⦂\ Cs\ ｝}. It
  suffices to show that \texttt{lookup\ ms\ k\ ≡\ lookup\ ns\ i}, which
  we have by symmetry.
\end{itemize}

\hypertarget{contexts}{%
\section{Contexts}\label{contexts}}

We choose to represent variables with de Bruijn indices, so contexts are
sequences of types.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{∅}%
\>[6]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Context}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Context}\<%
\end{code}
\end{fence}

\hypertarget{variables-and-the-lookup-judgment}{%
\section{Variables and the lookup
judgment}\label{variables-and-the-lookup-judgment}}

The lookup judgment is a three-place relation, with a context, a de
Bruijn index, and a type.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}∋\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{Z}%
\>[1095I]\AgdaSymbol{:}%
\>[1096I]\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1096I]%
\>[6]\AgdaComment{------------------}\<%
\\
\>[.][@{}l@{}]\<[1095I]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{S}%
\>[1106I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1106I]%
\>[4]\AgdaSymbol{→}%
\>[1112I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[1112I]%
\>[6]\AgdaComment{------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\end{code}
\end{fence}

\begin{itemize}
\item
  The index \texttt{0} has the type at the front of the context.
\item
  For the index \texttt{suc\ x}, we recursively look up its type in the
  remaining context \texttt{Γ}.
\end{itemize}

\hypertarget{terms-and-the-typing-judgment}{%
\section{Terms and the typing
judgment}\label{terms-and-the-typing-judgment}}

As mentioned above, variables are de Bruijn indices, which we represent
with natural numbers.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\end{code}
\end{fence}

Our terms are extrinsic, so we define a \texttt{Term} data type similar
to the one in the \protect\hyperlink{Lambda}{Lambda} chapter, but
adapted for de Bruijn indices. The two new term constructors are for
record creation and field access.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{`\AgdaUnderscore{}}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{ƛ\AgdaUnderscore{}}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}·\AgdaUnderscore{}}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaInductiveConstructor{`zero}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{`suc\AgdaUnderscore{}}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{case\AgdaUnderscore{}[zero⇒\AgdaUnderscore{}|suc⇒\AgdaUnderscore{}]}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{μ\AgdaUnderscore{}}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{｛\AgdaUnderscore{}:=\AgdaUnderscore{}｝}}%
\>[25]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}\#\AgdaUnderscore{}}}%
\>[26]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\end{code}
\end{fence}

In a record \texttt{｛\ ls\ :=\ Ms\ ｝}, we refer to the vector of terms
\texttt{Ms} as the \emph{field initializers}.

The typing judgment takes the form \texttt{Γ\ ⊢\ M\ ⦂\ A} and relies on
an auxiliary judgment \texttt{Γ\ ⊢*\ Ms\ ⦂\ As} for typing a vector of
terms.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢*\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1209I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[1209I]%
\>[6]\AgdaComment{-----------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢ƛ}%
\>[6]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1225I]\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[.][@{}l@{}]\<[1225I]%
\>[6]\AgdaComment{---------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
%
\>[4]\AgdaSymbol{→}%
\>[1254I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[1254I]%
\>[6]\AgdaComment{-------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{--------------}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaInductiveConstructor{`zero}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1278I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
\>[.][@{}l@{}]\<[1278I]%
\>[6]\AgdaComment{---------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[4]\AgdaSymbol{→}%
\>[1306I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[1306I]%
\>[6]\AgdaComment{---------------------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1329I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[1329I]%
\>[6]\AgdaComment{-------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{d}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{)}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{d}\AgdaSymbol{\}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢\#}%
\>[1381I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{i}\AgdaSymbol{\}\{}\AgdaBound{d}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1381I]%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSymbol{\{}\AgdaBound{d}\AgdaSymbol{\}}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{l}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1428I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}%
\>[18]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[.][@{}l@{}]\<[1428I]%
\>[6]\AgdaComment{--------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊢*\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{⊢*-[]}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
%
\>[5]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

Most of the typing rules are adapted from those in the
\protect\hyperlink{Lambda}{Lambda} chapter. Here we discuss the three
new rules.

\begin{itemize}
\item
  Rule \texttt{⊢rcd}: A record is well-typed if the field initializers
  \texttt{Ms} have types \texttt{As}, to match the record type. Also,
  the vector of field names is required to be distinct.
\item
  Rule \texttt{⊢\#}: A field access is well-typed if the term \texttt{M}
  has record type, the field \texttt{l} is at some index \texttt{i} in
  the record type's vector of field names, and the result type
  \texttt{A} is at index \texttt{i} in the vector of field types.
\item
  Rule \texttt{⊢\textless{}:}: (Subsumption) If a term \texttt{M} has
  type \texttt{A}, and \texttt{A\ \textless{}:\ B}, then term \texttt{M}
  also has type \texttt{B}.
\end{itemize}

\hypertarget{renaming-and-substitution}{%
\section{Renaming and Substitution}\label{renaming-and-substitution}}

In preparation of defining the reduction rules for this language, we
define simultaneous substitution using the same recipe as in the
\protect\hyperlink{DeBruijn}{DeBruijn} chapter, but adapted to extrinsic
terms. Thus, the \texttt{subst} function is split into two parts: a raw
\texttt{subst} function that operators on terms and a
\texttt{subst-pres} lemma that proves that substitution preserves types.
We define \texttt{subst} in this section and postpone
\texttt{subst-pres} to the
\protect\hyperlink{subtyping-preservation}{Preservation} section.
Likewise for \texttt{rename}.

We begin by defining the \texttt{ext} function on renamings.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaNumber{0}%
\>[13]\AgdaSymbol{=}%
\>[16]\AgdaNumber{0}\<%
\\
\>[0]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[15]\AgdaSymbol{=}%
\>[18]\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

The \texttt{rename} function is defined mutually with the auxiliary
\texttt{rename-vec} function, which is needed in the case for records.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{rename-vec}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{=}%
\>[27]\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{=}%
\>[27]\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{=}%
\>[27]\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`zero}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{=}%
\>[27]\AgdaInductiveConstructor{`zero}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{=}%
\>[27]\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{=}%
\>[27]\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaFunction{rename-vec}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{rename-vec}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaFunction{rename-vec}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaFunction{rename-vec}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{Ms}\<%
\end{code}
\end{fence}

With the \texttt{rename} function in hand, we can define the
\texttt{exts} function on substitutions.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{exts}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaNumber{0}%
\>[14]\AgdaSymbol{=}%
\>[17]\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
\>[0]\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[16]\AgdaSymbol{=}%
\>[19]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

We define \texttt{subst} mutually with the auxiliary \texttt{subst-vec}
function, which is needed in the case for records.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-vec}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{k}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`zero}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaInductiveConstructor{`zero}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}%
\>[1689I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[1689I]%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}%
\>[26]\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}%
\>[22]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaFunction{subst-vec}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-vec}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaFunction{subst-vec}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-vec}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

As usual, we implement single substitution using simultaneous
substitution.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
\>[0]\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaNumber{0}%
\>[21]\AgdaSymbol{=}%
\>[24]\AgdaBound{M}\<%
\\
\>[0]\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}[\AgdaUnderscore{}]}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}[\AgdaUnderscore{}]}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[12]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{N}\<%
\end{code}
\end{fence}

\hypertarget{values}{%
\section{Values}\label{values}}

We extend the definition of \texttt{Value} to include a clause for
records. In a call-by-value language, a record is usually only
considered a value if all its field initializers are values. Here we
instead treat records in a lazy fashion, declaring any record to be a
value, to save on some extra bookkeeping.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{V-ƛ}%
\>[1782I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1782I]%
\>[6]\AgdaComment{-----------}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{V-zero}\AgdaSpace{}%
\AgdaSymbol{:}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{-------------}\<%
\\
%
\>[6]\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`zero}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{V-suc}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1793I]\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{V}\<%
\\
\>[.][@{}l@{}]\<[1793I]%
\>[6]\AgdaComment{--------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{V-rcd}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\<%
\end{code}
\end{fence}

\hypertarget{reduction}{%
\section{Reduction}\label{reduction}}

The following datatype \texttt{\_—→\_} defines the reduction relation
for the STLC with records. We discuss the two new rules for records in
the following paragraph.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}—→\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{ξ-·₁}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{L′}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1829I]\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{L′}\<%
\\
\>[.][@{}l@{}]\<[1829I]%
\>[6]\AgdaComment{---------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{L′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{ξ-·₂}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{V}%
\>[15]\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{V}\<%
\\
%
\>[4]\AgdaSymbol{→}%
\>[1847I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
\>[.][@{}l@{}]\<[1847I]%
\>[6]\AgdaComment{---------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{β-ƛ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{W}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1863I]\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{W}\<%
\\
\>[.][@{}l@{}]\<[1863I]%
\>[6]\AgdaComment{--------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{·}}\AgdaSpace{}%
\AgdaBound{W}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{W}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{ξ-suc}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1880I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
\>[.][@{}l@{}]\<[1880I]%
\>[6]\AgdaComment{-----------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{ξ-case}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{L}\AgdaSpace{}%
\AgdaBound{L′}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1896I]\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{L′}\<%
\\
\>[.][@{}l@{}]\<[1896I]%
\>[6]\AgdaComment{-------------------------------------------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaBound{L}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaBound{L′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{β-zero}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[12]\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{----------------------------------}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaInductiveConstructor{`zero}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{β-suc}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{V}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1935I]\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{V}\<%
\\
\>[.][@{}l@{}]\<[1935I]%
\>[6]\AgdaComment{-------------------------------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{case}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{[zero⇒}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{|suc⇒}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{β-μ}%
\>[1950I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1950I]%
\>[6]\AgdaComment{----------------}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{μ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{ξ-\#}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{\}\{}\AgdaBound{l}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{M′}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{M′}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{β-\#}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{l}\AgdaSymbol{\}\{}\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[1994I]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{l}\<%
\\
\>[.][@{}l@{}]\<[1994I]%
\>[6]\AgdaComment{---------------------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\#}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}%
\>[27]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaBound{j}\<%
\end{code}
\end{fence}

We have just two new reduction rules: * Rule \texttt{ξ-\#}: A field
access expression \texttt{M\ \#\ l} reduces to \texttt{M′\ \#\ l}
provided that \texttt{M} reduces to \texttt{M′}.

\begin{itemize}
\tightlist
\item
  Rule \texttt{β-\#}: When field access is applied to a record, and if
  the label \texttt{l} is at position \texttt{j} in the vector of field
  names, then result is the term at position \texttt{j} in the field
  initializers.
\end{itemize}

\hypertarget{canonical-forms}{%
\section{Canonical Forms}\label{canonical-forms}}

As in the \protect\hyperlink{Properties}{Properties} chapter, we define
a \texttt{Canonical\ V\ ⦂\ A} relation that characterizes the well-typed
values. The presence of the subsumption rule impacts its definition
because we must allow the type of the value \texttt{V} to be a subtype
of \texttt{A}.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{Canonical\AgdaUnderscore{}⦂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaBound{D}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[7]\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
%
\>[4]\AgdaSymbol{→}%
\>[2030I]\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{D}\<%
\\
\>[.][@{}l@{}]\<[2030I]%
\>[6]\AgdaComment{-------------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{ƛ}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{C}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⇒}}\AgdaSpace{}%
\AgdaBound{D}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{C-zero}\AgdaSpace{}%
\AgdaSymbol{:}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{--------------------}\<%
\\
%
\>[6]\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaInductiveConstructor{`zero}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{C-suc}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[2051I]\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
\>[.][@{}l@{}]\<[2051I]%
\>[6]\AgdaComment{---------------------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{`suc}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaInductiveConstructor{`ℕ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{ks}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaFunction{Name}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaBound{Bs}\AgdaSymbol{\}\{}\AgdaBound{dls}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{dks}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{distinct}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSymbol{\{}\AgdaBound{dks}\AgdaSymbol{\}}%
\>[24]\AgdaOperator{\AgdaDatatype{<:}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{Bs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSymbol{\{}\AgdaBound{dls}\AgdaSymbol{\}}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{:=}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｛}}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⦂}}\AgdaSpace{}%
\AgdaBound{Bs}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{｝}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{dls}\AgdaSymbol{\}}\<%
\end{code}
\end{fence}

Every closed, well-typed value is canonical:

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{V}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[2114I]\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{V}\<%
\\
\>[.][@{}l@{}]\<[2114I]%
\>[4]\AgdaComment{-----------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaSymbol{())}%
\>[27]\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[27]\AgdaInductiveConstructor{V-ƛ}%
\>[39]\AgdaSymbol{=}%
\>[42]\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaFunction{<:-refl}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[27]\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}%
\>[27]\AgdaInductiveConstructor{V-zero}%
\>[39]\AgdaSymbol{=}%
\>[42]\AgdaInductiveConstructor{C-zero}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSymbol{)}%
\>[27]\AgdaSymbol{(}\AgdaInductiveConstructor{V-suc}\AgdaSpace{}%
\AgdaBound{VV}\AgdaSymbol{)}%
\>[39]\AgdaSymbol{=}%
\>[42]\AgdaInductiveConstructor{C-suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaBound{VV}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[27]\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{VV}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{dls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{d}\AgdaSpace{}%
\AgdaFunction{<:-refl}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaInductiveConstructor{<:-nat}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{VV}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaBound{VV}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{B}\AgdaSymbol{\}\{}\AgdaBound{C}\AgdaSymbol{\}\{}\AgdaBound{D}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{C<:A}\AgdaSpace{}%
\AgdaBound{B<:D}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{VV}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaBound{VV}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}\{}\AgdaBound{A′}\AgdaSymbol{\}\{}\AgdaBound{B′}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢N}%
\>[32]\AgdaBound{AB′<:AB}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaBound{AB′<:AB}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaBound{C<:A}\AgdaSpace{}%
\AgdaBound{B<:D}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ks}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSymbol{\}\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}\{}\AgdaArgument{d2}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ls⊆ks}\AgdaSpace{}%
\AgdaBound{ls⦂Ss<:ks⦂Ts}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{VV}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢V}\AgdaSpace{}%
\AgdaBound{VV}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[2202I]\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ks}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ks′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dks′}\AgdaSpace{}%
\AgdaBound{As<:Ss}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[.][@{}l@{}]\<[2202I]%
\>[6]\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{dls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{distinct-relevant}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dks′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{<:-trans}\AgdaSpace{}%
\AgdaBound{As<:Ss}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaBound{ls⊆ks}\AgdaSpace{}%
\AgdaBound{ls⦂Ss<:ks⦂Ts}\AgdaSymbol{))}\<%
\end{code}
\end{fence}

The case for subsumption (\texttt{⊢\textless{}:}) is interesting. We
proceed by cases on the derivation of subtyping.

\begin{itemize}
\item
  If the last rule is \texttt{\textless{}:-nat}, then we have
  \texttt{∅\ ⊢\ V\ ⦂\ ℕ} and the induction hypothesis gives us
  \texttt{Canonical\ V\ ⦂\ ℕ}.
\item
  If the last rule is \texttt{\textless{}:-fun}, then we have
  \texttt{A\ ⇒\ B\ \textless{}:\ C\ ⇒\ D} and
  \texttt{∅\ ⊢\ ƛ\ N\ ⦂\ A\ ⇒\ B}. By the induction hypothesis, we have
  \texttt{∅\ ,\ A′\ ⊢\ N\ ⦂\ B′} and
  \texttt{A′\ ⇒\ B′\ \textless{}:\ A\ ⇒\ B} for some \texttt{A′} and
  \texttt{B′}. We conclude that \texttt{Canonical\ (ƛ\ N)\ ⦂\ C\ ⇒\ D}
  by rule \texttt{C-ƛ} and the transitivity of subtyping.
\item
  If the last rule is \texttt{\textless{}:-rcd}, then we have
  \texttt{｛\ ls\ ⦂\ Ss\ ｝\ \textless{}:\ ｛\ ks\ ⦂\ Ts\ ｝} and
  \texttt{∅\ ⊢\ ｛\ ks′\ :=\ Ms\ ｝\ ⦂\ ｛\ ks\ ⦂\ Ss\ ｝}. By the
  induction hypothesis, we have \texttt{∅\ ⊢*\ Ms\ ⦂\ As},
  \texttt{distinct\ ks′}, and
  \texttt{｛\ ks′\ ⦂\ As\ ｝\ \textless{}:\ ｛\ ks\ ⦂\ Ss\ ｝}. We
  conclude that
  \texttt{Canonical\ ｛\ ks′\ :=\ Ms\ ｝\ ⦂\ ｛\ ks\ ⦂\ Ts\ ｝} by rule
  \texttt{C-rcd} and the transitivity of subtyping.
\end{itemize}

If a term is canonical, then it is also a value.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{value}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[2225I]\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[2225I]%
\>[4]\AgdaComment{----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
\>[0]\AgdaFunction{value}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[20]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{V-ƛ}\<%
\\
\>[0]\AgdaFunction{value}\AgdaSpace{}%
\AgdaInductiveConstructor{C-zero}%
\>[20]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{V-zero}\<%
\\
\>[0]\AgdaFunction{value}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{C-suc}\AgdaSpace{}%
\AgdaBound{CM}\AgdaSymbol{)}%
\>[20]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{V-suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{value}\AgdaSpace{}%
\AgdaBound{CM}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{value}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{V-rcd}\<%
\end{code}
\end{fence}

A canonical value is a well-typed value.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{typed}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{V}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[2252I]\AgdaOperator{\AgdaDatatype{Canonical}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[2252I]%
\>[4]\AgdaComment{---------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{V}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{typed}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaBound{AB<:CD}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{AB<:CD}\<%
\\
\>[0]\AgdaFunction{typed}\AgdaSpace{}%
\AgdaInductiveConstructor{C-zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}\<%
\\
\>[0]\AgdaFunction{typed}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{C-suc}\AgdaSpace{}%
\AgdaBound{c}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{typed}\AgdaSpace{}%
\AgdaBound{c}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{typed}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dks}\AgdaSpace{}%
\AgdaBound{As<:Bs}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dks}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{As<:Bs}\<%
\end{code}
\end{fence}

\hypertarget{progress}{%
\section{\texorpdfstring{Progress }{Progress }}\label{progress}}

The Progress theorem states that a well-typed term may either take a
reduction step or it is already a value. The proof of Progress is like
the one in the \protect\hyperlink{Properties}{Properties}; it proceeds
by induction on the typing derivation and most of the cases remain the
same. Below we discuss the new cases for records and subsumption.

\begin{fence}
\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}%
\>[2298I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[2298I]%
\>[6]\AgdaComment{----------}\<%
\\
%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Progress}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaSymbol{:}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaDatatype{Value}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
%
\>[6]\AgdaComment{----------}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Progress}\AgdaSpace{}%
\AgdaBound{M}\<%
\end{code}
\end{fence}

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[2311I]\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[2311I]%
\>[4]\AgdaComment{----------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Progress}\AgdaSpace{}%
\AgdaBound{M}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaSymbol{())}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[44]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaInductiveConstructor{V-ƛ}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{progress}\AgdaSpace{}%
\AgdaBound{⊢L}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaBound{L—→L′}%
\>[44]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-·₁}\AgdaSpace{}%
\AgdaBound{L—→L′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}%
\>[2336I]\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaBound{VL}\<%
\\
\>[2336I][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{progress}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[8]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaBound{M—→M′}%
\>[44]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-·₂}\AgdaSpace{}%
\AgdaBound{VL}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[8]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaBound{VM}\<%
\\
%
\>[8]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{VL}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[8]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[44]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{β-ƛ}\AgdaSpace{}%
\AgdaBound{VM}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaInductiveConstructor{V-zero}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{progress}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[5]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaBound{M—→M′}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-suc}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[5]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaBound{VM}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{V-suc}\AgdaSpace{}%
\AgdaBound{VM}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{progress}\AgdaSpace{}%
\AgdaBound{⊢L}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaBound{L—→L′}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-case}\AgdaSpace{}%
\AgdaBound{L—→L′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaBound{VL}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{VL}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[6]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-zero}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaInductiveConstructor{β-zero}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[6]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-suc}\AgdaSpace{}%
\AgdaBound{CL}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{β-suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{value}\AgdaSpace{}%
\AgdaBound{CL}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaInductiveConstructor{β-μ}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{l}\AgdaSymbol{\}\{}\AgdaBound{ls}\AgdaSymbol{\}\{}\AgdaBound{As}\AgdaSymbol{\}\{}\AgdaBound{i}\AgdaSymbol{\}\{}\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{ls[i]=l}\AgdaSpace{}%
\AgdaBound{As[i]=A}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{progress}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaBound{M—→M′}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-\#}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[2413I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaBound{VM}\<%
\\
\>[.][@{}l@{}]\<[2413I]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{VM}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[2419I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ks}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ms}\AgdaSymbol{\}\{}\AgdaArgument{As}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Bs}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaBound{ls⊆ms}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\<%
\\
\>[.][@{}l@{}]\<[2419I]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ls⊆ms}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ls[i]=ms[k]}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{step}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{β-\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{j}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{\}(}\AgdaFunction{trans}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{ls[i]=ms[k]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ls[i]=l}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{)}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaInductiveConstructor{V-rcd}\<%
\\
\>[0]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{A}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{A<:B}\AgdaSymbol{)}%
\>[44]\AgdaSymbol{=}%
\>[47]\AgdaFunction{progress}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\end{code}
\end{fence}

\begin{itemize}
\item
  Case \texttt{⊢\#}: We have \texttt{Γ\ ⊢\ M\ ⦂\ ｛\ ls\ ⦂\ As\ ｝},
  \texttt{lookup\ ls\ i\ ≡\ l}, and \texttt{lookup\ As\ i\ ≡\ A}. By the
  induction hypothesis, either \texttt{M\ —→\ M′} or \texttt{M} is a
  value. In the later case we conclude that
  \texttt{M\ \#\ l\ —→\ M′\ \#\ l} by rule \texttt{ξ-\#}. On the other
  hand, if \texttt{M} is a value, we invoke the canonical forms lemma to
  show that \texttt{M} has the form \texttt{｛\ ms\ :=\ Ms\ ｝} where
  \texttt{∅\ ⊢*\ Ms\ ⦂\ Bs} and \texttt{ls\ ⊆\ ms}. By lemma
  \texttt{lookup-⊆}, we have \texttt{lookup\ ls\ i\ ≡\ lookup\ ms\ k}
  for some \texttt{k}. Thus, we have \texttt{lookup\ ms\ k\ ≡\ l} and we
  conclude \texttt{｛\ ms\ :=\ Ms\ ｝\ \#\ l\ —→\ lookup\ Ms\ k} by rule
  \texttt{β-\#}.
\item
  Case \texttt{⊢rcd}: we immediately characterize the record as a value.
\item
  Case \texttt{⊢\textless{}:}: we invoke the induction hypothesis on
  sub-derivation of \texttt{Γ\ ⊢\ M\ ⦂\ A}.
\end{itemize}

\hypertarget{preservation}{%
\section{\texorpdfstring{Preservation
}{Preservation }}\label{preservation}}

In this section we prove that when a well-typed term takes a reduction
step, the result is another well-typed term with the same type.

As mentioned earlier, we need to prove that substitution preserve types,
which in turn requires that renaming preserves types. The proofs of
these lemmas are adapted from the intrinsic versions of the
\texttt{ext}, \texttt{rename}, \texttt{exts}, and \texttt{subst}
functions in the \protect\hyperlink{DeBruijn}{DeBruijn} chapter.

We define the following abbreviation for a \emph{well-typed renaming}
from Γ to Δ, that is, a renaming that sends variables in Γ to variables
in Δ with the same type.

\begin{fence}
\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⦂ᵣ\AgdaUnderscore{}⇒\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Id}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂ᵣ}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\end{code}
\end{fence}

The \texttt{ext} function takes a well-typed renaming from Γ to Δ and
extends it to become a renaming from (Γ , B) to (Δ , B).

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ext-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[2497I]\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂ᵣ}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
\>[.][@{}l@{}]\<[2497I]%
\>[4]\AgdaComment{--------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂ᵣ}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{ext-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\<%
\\
\>[0]\AgdaFunction{ext-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{S}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{∋x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[39]\AgdaInductiveConstructor{S}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{∋x}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

Next we prove that both \texttt{rename} and \texttt{rename-vec} preserve
types. We use the \texttt{ext-pres} lemma in each of the cases with a
variable binding: \texttt{⊢ƛ}, \texttt{⊢μ}, and \texttt{⊢case}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{ren-vec-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂ᵣ}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}%
\>[16]\AgdaSymbol{→}%
\>[19]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{As}%
\>[33]\AgdaSymbol{→}%
\>[36]\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaFunction{rename-vec}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂ᵣ}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[2573I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[2573I]%
\>[4]\AgdaComment{------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaBound{∋w}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}%
\>[36]\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{∋w}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}%
\>[36]\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)=}%
\>[36]\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}%
\>[36]\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ren-vec-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{dls}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{lif}\AgdaSpace{}%
\AgdaBound{liA}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lif}\AgdaSpace{}%
\AgdaBound{liA}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}%
\>[35]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[35]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[35]\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{ren-vec-pres}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢*-[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢*-[]}\<%
\\
\>[0]\AgdaFunction{ren-vec-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{IH}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ren-vec-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[2]\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{IH}\<%
\end{code}
\end{fence}

A \emph{well-typed substitution} from Γ to Δ sends variables in Γ to
terms of the same type in the context Δ.

\begin{fence}
\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⦂\AgdaUnderscore{}⇒\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Id}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Context}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\end{code}
\end{fence}

The \texttt{exts} function sends well-typed substitutions from Γ to Δ to
well-typed substitutions from (Γ , B) to (Δ , B). In the case for
\texttt{S}, we note that
\texttt{exts\ σ\ (suc\ x)\ ≡\ rename\ sub\ (σ\ x)}, so we need to prove
\texttt{Δ\ ,\ B\ ⊢\ rename\ suc\ (σ\ x)\ ⦂\ A}, which we obtain by the
\texttt{rename-pres} lemma.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{exts-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}%
\>[2784I]\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
\>[.][@{}l@{}]\<[2784I]%
\>[4]\AgdaComment{--------------------------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{exts-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\<%
\\
\>[0]\AgdaFunction{exts-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{S}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{∋x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{S}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{∋x}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

Now we prove that both \texttt{subst} and \texttt{subst-vec} preserve
types. We use the \texttt{exts-pres} lemma in each of the cases with a
variable binding: \texttt{⊢ƛ}, \texttt{⊢μ}, and \texttt{⊢case}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{subst-vec-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}%
\>[15]\AgdaSymbol{→}%
\>[18]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}%
\>[31]\AgdaSymbol{→}%
\>[34]\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaFunction{subst-vec}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⦂}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⇒}}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[2860I]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[.][@{}l@{}]\<[2860I]%
\>[4]\AgdaComment{-----------------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaBound{eq}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{eq}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}(}\AgdaFunction{exts-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts-pres}\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dls}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢rcd}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-vec-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{dls}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{lif}\AgdaSpace{}%
\AgdaBound{liA}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lif}\AgdaSpace{}%
\AgdaBound{liA}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaBound{lt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lt}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{subst-vec-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢*-[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢*-[]}\<%
\\
\>[0]\AgdaFunction{subst-vec-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-vec-pres}\AgdaSpace{}%
\AgdaBound{σ⦂}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSymbol{)}\<%
\end{code}
\end{fence}

The fact that single substitution preserves types is a corollary of
\texttt{subst-pres}.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{B}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[3]\AgdaSymbol{→}%
\>[3038I]\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[.][@{}l@{}]\<[3038I]%
\>[5]\AgdaComment{---------------}\<%
\\
%
\>[3]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{B}\AgdaSymbol{\}\{}\AgdaBound{M}\AgdaSymbol{\}\{}\AgdaBound{N}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaFunction{G}\AgdaSpace{}%
\AgdaBound{⊢N}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{where}\<%
\\
%
\>[4]\AgdaFunction{G}%
\>[3064I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{C}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[3064I]%
\>[6]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∋}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{C}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst-zero}\AgdaSpace{}%
\AgdaBound{M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{`}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{C}\<%
\\
%
\>[4]\AgdaFunction{G}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{Z}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
%
\>[4]\AgdaFunction{G}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{S}\AgdaSpace{}%
\AgdaBound{∋x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaBound{∋x}\<%
\end{code}
\end{fence}

We require just one last lemma before we get to the proof of
preservation. The following lemma establishes that field access
preserves types.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{field-pres}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀\{}\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{As}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Type}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Vec}\AgdaSpace{}%
\AgdaDatatype{Term}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}\{}\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[9]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢*}}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{As}\<%
\\
%
\>[9]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{As}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[9]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{Ms}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{field-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaFunction{field-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢*-∷}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{As[i]=A}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{field-pres}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{As[i]=A}\<%
\end{code}
\end{fence}

The proof is by induction on the typing derivation.

\begin{itemize}
\item
  Case \texttt{⊢-*-{[}{]}}: This case yields a contradiction because
  \texttt{Fin\ 0} is uninhabitable.
\item
  Case \texttt{⊢-*-∷}: So we have \texttt{∅\ ⊢\ M\ ⦂\ B} and
  \texttt{∅\ ⊢*\ Ms\ ⦂\ As}. We proceed by cases on \texttt{i}.

  \begin{itemize}
  \item
    If it is \texttt{0}, then lookup yields term \texttt{M} and
    \texttt{A\ ≡\ B}, so we conclude that \texttt{∅\ ⊢\ M\ ⦂\ A}.
  \item
    If it is \texttt{suc\ i}, then we conclude by the induction
    hypothesis.
  \end{itemize}
\end{itemize}

We conclude this chapter with the proof of preservation. We discuss the
cases particular to records and subtyping in the paragraph following the
Agda proof.

\begin{fence}
\begin{code}%
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{M}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[2]\AgdaSymbol{→}%
\>[3163I]\AgdaBound{M}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{—→}}\AgdaSpace{}%
\AgdaBound{N}\<%
\\
\>[.][@{}l@{}]\<[3163I]%
\>[4]\AgdaComment{----------}\<%
\\
%
\>[2]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{∅}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊢}}\AgdaSpace{}%
\AgdaBound{N}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⦂}}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢`}\AgdaSpace{}%
\AgdaSymbol{())}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-·₁}\AgdaSpace{}%
\AgdaBound{L—→L′}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{L—→L′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-·₂}\AgdaSpace{}%
\AgdaBound{VL}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢·}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{β-ƛ}\AgdaSpace{}%
\AgdaBound{VL}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaInductiveConstructor{V-ƛ}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-ƛ}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-fun}\AgdaSpace{}%
\AgdaBound{CA}\AgdaSpace{}%
\AgdaBound{BC}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{CA}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{BC}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢zero}%
\>[33]\AgdaSymbol{()}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-suc}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-case}\AgdaSpace{}%
\AgdaBound{L—→L′}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{L—→L′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{β-zero}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢case}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{⊢N}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{β-suc}\AgdaSpace{}%
\AgdaBound{VV}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢L}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{V-suc}\AgdaSpace{}%
\AgdaBound{VV}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-suc}\AgdaSpace{}%
\AgdaBound{CV}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{typed}\AgdaSpace{}%
\AgdaBound{CV}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢N}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}%
\>[33]\AgdaSymbol{(}\AgdaInductiveConstructor{β-μ}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaFunction{substitution}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢μ}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{⊢M}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{lsi}\AgdaSpace{}%
\AgdaBound{Asi}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ξ-\#}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{d}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{M—→M′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{lsi}\AgdaSpace{}%
\AgdaBound{Asi}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ls}\AgdaSymbol{\}\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{β-\#}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ls}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSymbol{\}\{}\AgdaBound{Ms}\AgdaSymbol{\}\{}\AgdaArgument{j}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ks[j]=l}\AgdaSymbol{)}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{canonical}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaInductiveConstructor{V-rcd}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[3288I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{C-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{As}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Bs}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaBound{dks}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{<:-rcd}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{ks}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ks}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ls⊆ks}\AgdaSpace{}%
\AgdaBound{Bs<:As}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3288I]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{lookup-⊆}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ls⊆ks}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[3306I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟨}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ls[i]=ks[k]}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⟩}}\<%
\\
\>[.][@{}l@{}]\<[3306I]%
\>[4]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{field-pres}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{⊢Ms}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaSymbol{...}%
\>[3318I]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{⊢Ms[k]⦂Bs[k]}\<%
\\
\>[.][@{}l@{}]\<[3318I]%
\>[4]\AgdaKeyword{rewrite}\AgdaSpace{}%
\AgdaFunction{distinct-lookup-inj}\AgdaSpace{}%
\AgdaBound{dks}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{trans}\AgdaSpace{}%
\AgdaBound{ks[j]=l}\AgdaSpace{}%
\AgdaBound{ls[i]=ks[k]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
%
\>[4]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{Ms[k]⦂As[i]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢Ms[k]⦂Bs[k]}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Bs<:As}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sym}\AgdaSpace{}%
\AgdaBound{ls[i]=ks[k]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
%
\>[4]\AgdaBound{Ms[k]⦂As[i]}\<%
\\
\>[0]\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{B<:A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{M—→N}%
\>[50]\AgdaSymbol{=}%
\>[53]\AgdaInductiveConstructor{⊢<:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{preserve}\AgdaSpace{}%
\AgdaBound{⊢M}\AgdaSpace{}%
\AgdaBound{M—→N}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{B<:A}\<%
\end{code}
\end{fence}

Recall that the proof is by induction on the derivation of
\texttt{∅\ ⊢\ M\ ⦂\ A} with cases on \texttt{M\ —→\ N}.

\begin{itemize}
\item
  Case \texttt{⊢\#} and \texttt{ξ-\#}: So
  \texttt{∅\ ⊢\ M\ ⦂\ ｛\ ls\ ⦂\ As\ ｝}, \texttt{lookup\ ls\ i\ ≡\ l},
  \texttt{lookup\ As\ i\ ≡\ A}, and \texttt{M\ —→\ M′}. We apply the
  induction hypothesis to obtain \texttt{∅\ ⊢\ M′\ ⦂\ ｛\ ls\ ⦂\ As\ ｝}
  and then conclude by rule \texttt{⊢\#}.
\item
  Case \texttt{⊢\#} and \texttt{β-\#}. We have
  \texttt{∅\ ⊢\ ｛\ ks\ :=\ Ms\ ｝\ ⦂\ ｛\ ls\ ⦂\ As\ ｝},
  \texttt{lookup\ ls\ i\ ≡\ l}, \texttt{lookup\ As\ i\ ≡\ A},
  \texttt{lookup\ ks\ j\ ≡\ l}, and
  \texttt{｛\ ks\ :=\ Ms\ ｝\ \#\ l\ —→\ lookup\ Ms\ j}. By the
  canonical forms lemma, we have \texttt{∅\ ⊢*\ Ms\ ⦂\ Bs},
  \texttt{ls\ ⊆\ ks} and \texttt{ks\ ⦂\ Bs\ \textless{}:\ ls\ ⦂\ As}. By
  lemma \texttt{lookup-⊆} we have
  \texttt{lookup\ ls\ i\ ≡\ lookup\ ks\ k} for some \texttt{k}. Also, we
  have \texttt{∅\ ⊢\ lookup\ Ms\ k\ ⦂\ lookup\ Bs\ k} by lemma
  \texttt{field-pres}. Then because
  \texttt{ks\ ⦂\ Bs\ \textless{}:\ ls\ ⦂\ As} and
  \texttt{lookup\ ks\ k\ ≡\ lookup\ ls\ i}, we have
  \texttt{lookup\ Bs\ k\ \textless{}:\ lookup\ As\ i}. So by rule
  \texttt{⊢\textless{}:} we have
  \texttt{∅\ ⊢\ lookup\ Ms\ k\ ⦂\ lookup\ As\ i}. Finally, because
  \texttt{lookup} is injective and
  \texttt{lookup\ ks\ j\ ≡\ lookup\ ks\ k}, we have \texttt{j\ ≡\ k} and
  conclude that \texttt{∅\ ⊢\ lookup\ Ms\ j\ ⦂\ lookup\ As\ i}.
\item
  Case \texttt{⊢\textless{}:}. We have \texttt{∅\ ⊢\ M\ ⦂\ B},
  \texttt{B\ \textless{}:\ A}, and \texttt{M\ —→\ N}. We apply the
  induction hypothesis to obtain \texttt{∅\ ⊢\ N\ ⦂\ B} and then
  subsumption to conclude that \texttt{∅\ ⊢\ N\ ⦂\ A}.
\end{itemize}

\hypertarget{exercise-intrinsic-records-stretch}{%
\subsubsection{\texorpdfstring{Exercise \texttt{intrinsic-records}
(stretch)}{Exercise intrinsic-records (stretch)}}\label{exercise-intrinsic-records-stretch}}

Formulate the language of this chapter, STLC with records, using
intrinsically typed terms. This requires taking an algorithmic approach
to the type system, which means that there is no subsumption rule and
instead subtyping is used in the elimination rules. For example, the
rule for function application would be:

\begin{myDisplay}
_·_ : ∀ {Γ A B C}
  → Γ ⊢ A ⇒ B
  → Γ ⊢ C
  → C <: A
    -------
  → Γ ⊢ B
\end{myDisplay}

\hypertarget{exercise-type-check-records-practice}{%
\subsubsection{\texorpdfstring{Exercise \texttt{type-check-records}
(practice)}{Exercise type-check-records (practice)}}\label{exercise-type-check-records-practice}}

Write a recursive function whose input is a \texttt{Term} and whose
output is a typing derivation for that term, if one exists.

\begin{myDisplay}
type-check : (M : Term) → (Γ : Context) → Maybe (Σ[ A ∈ Type ] Γ ⊢ M ⦂ A)
\end{myDisplay}

\hypertarget{exercise-variants-recommended}{%
\subsubsection{\texorpdfstring{Exercise \texttt{variants}
(recommended)}{Exercise variants (recommended)}}\label{exercise-variants-recommended}}

Add variants to the language of this chapter and update the proofs of
progress and preservation. The variant type is a generalization of a sum
type, similar to the way the record type is a generalization of product.
The following summarizes the treatment of variants in the book Types and
Programming Languages. A variant type is traditionally written:

\begin{myDisplay}
〈l₁:A₁, ..., lᵤ:Aᵤ〉
\end{myDisplay}

The term for introducing a variant is

\begin{myDisplay}
〈l=t〉
\end{myDisplay}

and the term for eliminating a variant is

\begin{myDisplay}
case L of 〈l₁=x₁〉 ⇒ M₁ | ... | 〈lᵤ=xᵤ〉 ⇒ Mᵤ
\end{myDisplay}

The typing rules for these terms are

\begin{myDisplay}
(T-Variant)
Γ ⊢ Mⱼ : Aⱼ
---------------------------------
Γ ⊢ 〈lⱼ=Mⱼ〉 : 〈l₁=A₁, ... , lᵤ=Aᵤ〉


(T-Case)
Γ ⊢ L : 〈l₁=A₁, ... , lᵤ=Aᵤ〉
∀ i ∈ 1..u,   Γ,xᵢ:Aᵢ ⊢ Mᵢ : B
---------------------------------------------------
Γ ⊢ case L of 〈l₁=x₁〉 ⇒ M₁ | ... | 〈lᵤ=xᵤ〉 ⇒ Mᵤ  : B
\end{myDisplay}

The non-algorithmic subtyping rules for variants are

\begin{myDisplay}
(S-VariantWidth)
------------------------------------------------------------
〈l₁=A₁, ..., lᵤ=Aᵤ〉   <:   〈l₁=A₁, ..., lᵤ=Aᵤ, ..., lᵤ₊ₓ=Aᵤ₊ₓ〉

(S-VariantDepth)
∀ i ∈ 1..u,    Aᵢ <: Bᵢ
---------------------------------------------
〈l₁=A₁, ..., lᵤ=Aᵤ〉   <:   〈l₁=B₁, ..., lᵤ=Bᵤ〉

(S-VariantPerm)
∀i∈1..u, ∃j∈1..u, kⱼ = lᵢ and Aⱼ = Bᵢ
----------------------------------------------
〈k₁=A₁, ..., kᵤ=Aᵤ〉   <:   〈l₁=B₁, ..., lᵤ=Bᵤ〉
\end{myDisplay}

Come up with an algorithmic subtyping rule for variant types.

\hypertarget{exercise--alternative-stretch}{%
\subsubsection{\texorpdfstring{Exercise
\texttt{\textless{}:-alternative}
(stretch)}{Exercise \textless:-alternative (stretch)}}\label{exercise--alternative-stretch}}

Revise this formalisation of records with subtyping (including proofs of
progress and preservation) to use the non-algorithmic subtyping rules
for Chapter 15 of Types and Programming Languages, which we list here:

\begin{myDisplay}
(S-RcdWidth)
--------------------------------------------------------------
{ l₁:A₁, ..., lᵤ:Aᵤ, ..., lᵤ₊ₓ:Aᵤ₊ₓ } <: { l₁:A₁, ..., lᵤ:Aᵤ }

(S-RcdDepth)
    ∀i∈1..u, Aᵢ <: Bᵢ
----------------------------------------------
{ l₁:A₁, ..., lᵤ:Aᵤ } <: { l₁:B₁, ..., lᵤ:Bᵤ }

(S-RcdPerm)
∀i∈1..u, ∃j∈1..u, kⱼ = lᵢ and Aⱼ = Bᵢ
----------------------------------------------
{ k₁:A₁, ..., kᵤ:Aᵤ } <: { l₁:B₁, ..., lᵤ:Bᵤ }
\end{myDisplay}

You will most likely need to prove inversion lemmas for the subtype
relation of the form:

\begin{myDisplay}
If S <: T₁ ⇒ T₂, then S ≡ S₁ ⇒ S₂, T₁ <: S₁, and S₂ <: T₂, for some S₁, S₂.

If S <: { lᵢ : Tᵢ | i ∈ 1..n }, then S ≡ { kⱼ : Sⱼ | j ∈ 1..m }
and { lᵢ | i ∈ 1..n } ⊆ { kⱼ | j ∈ 1..m }
and Sⱼ <: Tᵢ for every i and j such that lᵢ = kⱼ.
\end{myDisplay}

\hypertarget{references}{%
\section{References}\label{references}}

\begin{itemize}
\item
  John C. Reynolds. Using Category Theory to Design Implicit Conversions
  and Generic Operators. In Semantics-Directed Compiler Generation,
  1980. LNCS Volume 94.
\item
  Luca Cardelli. A semantics of multiple inheritance. In Semantics of
  Data Types, 1984. Springer.
\item
  Barbara H. Liskov and Jeannette M. Wing. A Behavioral Notion of
  Subtyping. In ACM Trans. Program. Lang. Syst. Volume 16, 1994.
\item
  Types and Programming Languages. Benjamin C. Pierce. The MIT Press.
  2002.
\end{itemize}

